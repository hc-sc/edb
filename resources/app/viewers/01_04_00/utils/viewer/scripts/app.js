!function(){"use strict";var a=angular.module("GhstsViewer",["pasvaz.bindonce","ui.bootstrap","ui.layout","ghsts-util","ghsts-document-table","ghsts-model","ghsts-main","ghsts-history","ghsts-bookmark","ghsts-controller-menu","ghsts-controller-filter","ghsts-controller-toc","ghsts-controller-structure","ghsts-detail-controllers","ghsts-state-service","ghsts-annotations","ghsts-filter-service","cfp.hotkeys"]);a.run(["GhstsModelData","CONFIG","GhstsStateService","GhstsViewerFilter","PdfLinkService","UtilService",function(a,b,c,d,e,f){
// notify DesktopViewer about loading state and document results
if(
// load the xml file and fill the model data
a.init(),d.initFilter(),c.init(),e.init(),angular.isDefined(parent.viewerAPI)){var g=f.getSubmissionPath();parent.viewerAPI.loadedDossier(g,a.getViewModel("dossier"),a.getViewModel("documents"))}}])}(),function(){"use strict";/*
   * These contain global constants
   */
angular.module("ghsts-constants",[]).constant("CONFIG",{VIEWER_VERSION:"02.00.03",PDFJS_VERSION:"1.5.250 c1c199d",TREECONTROL_VERSION:"0.2.25",SMARTTABLECONTROL_VERSION:"2.1.8",PDFJS_FILE_PATH:"pdfjs/viewer.html?file=",USE_ANNOTATIONS:!1,// we currently don't need the annotation module,
HISTORY_SIZE:10,
// Path to submission folder & file
// will be replaced during build
//SUBMISSION_ROOT: 'sample_submissions/GHSTS2015-UI/04/',
//SUBMISSION_FILE: 'sample_submissions/GHSTS2015-UI/04/ghsts.xml'
// SUBMISSION_ROOT: 'sample_submissions/P-000845-100D6/02/',
// SUBMISSION_FILE: 'sample_submissions/P-000845-100D6/02/ghsts.xml'
//SUBMISSION_ROOT: 'sample_submissions/Grenzwerte/01/',
//SUBMISSION_FILE: 'sample_submissions/Grenzwerte/01/ghsts.xml'
// SUBMISSION_ROOT: 'sample_submissions/hurzPL100D6/03/',
// SUBMISSION_FILE: 'sample_submissions/hurzPL100D6/03/ghsts.xml'
// SUBMISSION_ROOT: 'sample_submissions/BCSDE100RO/02/',
// SUBMISSION_FILE: 'sample_submissions/BCSDE100RO/02/ghsts.xml'
// SUBMISSION_ROOT: 'sample_submissions/GHSTS-Sample_Dossier/04/',
// SUBMISSION_FILE: 'sample_submissions/GHSTS-Sample_Dossier/04/ghsts.xml'
SUBMISSION_ROOT:"../../",SUBMISSION_FILE:"../../ghsts.xml"})}(),function(){"use strict";function a(a){
// public API
var b={getSubmissionPath:function(){var b=window.location.href;return b.indexOf("#")>=0&&(b=b.substring(0,b.indexOf("#"))),b=b.substring(0,b.lastIndexOf("/")),b+"/"+a.SUBMISSION_ROOT}};return b}angular.module("ghsts-util",["ghsts-constants"]).factory("UtilService",a),a.$inject=["CONFIG"]}(),function(){"use strict";function a(a){
////////////
function b(){console.debug("Start XML load: "+Date.now()),$.ajax({url:a.SUBMISSION_FILE,async:!1,dataType:"text",type:"GET",success:function(a){console.debug("Finished XML load: "+Date.now()),c=$(a),console.debug("Finished XML jquery load: "+Date.now())},error:function(a){alert("Error loading file!"),console.error("ERROR: [GHSTS Viewer] failed to load XML Dossier: "),console.error(a)}})}var c={},d={getData:function(){return c}};return b(),d}angular.module("DataAccess",["ghsts-constants"]).factory("DataAccessFactory",a),a.$inject=["CONFIG"]}(),function(){var a=angular.module("ghsts-model",["DataAccess"]);a.service("GhstsModelData",["DataAccessFactory",function(a){var b=this;b.xmlData={},b.ViewModel={},this.getSubmissionPath=function(a,b){a=decodeURIComponent(a),0===a.indexOf("file:///")&&(a=a.replace("file:///",""));
// 2. remove everything behind first #
var c=a.indexOf("#");c>=0&&(a=a.substring(0,c));
// 3. remove everything behind last /
var d=a.lastIndexOf("/");
// 4. move directories up - as many as given
if(d>=0&&(a=a.substring(0,d+1)),b){for(;b>0;b--){var e=a.lastIndexOf("/");if(!(e>=0))break;a=a.substring(0,e)}a+="/"}return a},
// pre-generate ViewModel (calling all following generator-functions)
this.generateViewModel=function(){angular.isUndefined(b.ViewModel)&&(b.ViewModel={}),this.generateLEGAL_ENTITIES(),this.generateRECEIVERS(),this.generateSUBSTANCES(),this.generatePRODUCT(),this.generateDOSSIER(),this.generateFILES(),this.generateDOCUMENTS(),this.generateDOCLIST(),this.generateFILTER(),this.generateTOC(),this.generateTREE(),this.generateINFO()},this.generateLEGAL_ENTITIES=function(){angular.isUndefined(b.ViewModel.LEGAL_ENTITIES)&&(b.ViewModel.LEGAL_ENTITIES={});for(var a=[],c=$("LEGAL_ENTITIES LEGAL_ENTITY",b.xmlData),d=0;d<c.length;d++){var e=$(c[d]),f={};f=b.mapOneToOne(e,["LEGALENTITY_PID","LEGALENTITY_NAME"]),f.OTHER_NAME=b.makeArray(e.children("OTHER_NAME")),f._Id=e.attr("Id"),f.METADATA_STATUS=b.getValue(e.children("METADATA_STATUS"),!1),f.LEGALENTITY_TYPE=b.getValue(e.children("LEGALENTITY_TYPE"),!0),f.LEGALENTITY_IDENTIFIER=[];var g=e.children("LEGALENTITY_IDENTIFIER");if(g&&g.length>0)for(var h=0;h<g.length;h++){var i=$(g[h]),j={};j.LEGALENTITY_IDENTIFIER_TYPE=b.getValue(i.children("LEGALENTITY_IDENTIFIER_TYPE"),!0),j.IDENTIFIER=i.children("IDENTIFIER").text(),f.LEGALENTITY_IDENTIFIER.push(j)}f.CONTACT_ADDRESS={},f.CONTACT_ADDRESS=b.mapOneToOne(e.children("CONTACT_ADDRESS"),["STREET1","STREET2","ZIPCODE","CITY","STATE","PHONE","FAX","EMAIL","WEBSITE"]),f.CONTACT_ADDRESS.COUNTRY=b.getValue(e.children("CONTACT_ADDRESS").children("COUNTRY"),!0),f.CONTACT_PERSON=[];var k=e.children("CONTACT_PERSON");if(k&&k.length>0)for(var h=0;h<k.length;h++){var l=$(k[h]),m={};m=b.mapOneToOne(l,["ORGANISATION","DEPARTMENT","TITLE","FIRSTNAME","LASTNAME","PHONE","MOBILE","FAX","EMAIL"]),f.CONTACT_PERSON.push(m)}a.push(f)}b.ViewModel.LEGAL_ENTITIES=a},this.generateRECEIVERS=function(){angular.isUndefined(b.ViewModel.RECEIVERS)&&(b.ViewModel.RECEIVERS={});for(var a=[],c=$("RECEIVERS RECEIVER",b.xmlData),d=0;d<c.length;d++){var e=$(c[d]),f={};f=b.mapOneToOne(e,["SHORT_NAME","ROLE"]),f._Id=e.attr("Id"),f.REF_RA_Id=f._Id,f.forRA=[],f.forRA.push(f._Id),f.METADATA_STATUS=b.getValue(e.children("METADATA_STATUS"),!1),f.REF_LE_Id=b.getReferences(e,"To_Legal_Entity_Id"),f.LEGAL_ENTITY=b.resolveLegalEntity(f.REF_LE_Id),f.SENDER=[];for(var g=[],h=e.children("SENDER"),i=0;i<h.length;i++){var j=$(h[i]),k={};k=b.mapOneToOne(j,["COMPANY_CONTACT_REGULATORY_ROLE","REMARK"]),k.REF_LE_Id=b.getReferences(j,"To_Legal_Entity_Id"),k.LEGAL_ENTITY=b.resolveLegalEntity(k.REF_LE_Id),g.push(k)}f.SENDER=g,a.push(f)}b.ViewModel.RECEIVERS=a},this.generateSUBSTANCES=function(){angular.isUndefined(b.ViewModel.SUBSTANCES)&&(b.ViewModel.SUBSTANCES={});for(var a=[],c=$("SUBSTANCES SUBSTANCE",b.xmlData),d=0;d<c.length;d++){var e=$(c[d]),f={};f=b.mapOneToOne(e,["SUBSTANCE_PID","SUBSTANCE_NAME"]),f._Id=e.attr("Id"),f.METADATA_STATUS=b.getValue(e.children("METADATA_STATUS"),!1),f.SUBSTANCE_IDENTIFIER=[];var g=e.children("SUBSTANCE_IDENTIFIER");if(g&&g.length>0)for(var h=0;h<g.length;h++){var i=$(g[h]),j={};j.SUBSTANCE_IDENTIFIER_TYPE=b.getValue(i.children("SUBSTANCE_IDENTIFIER_TYPE"),!0),j.IDENTIFIER=i.children("IDENTIFIER").text(),f.SUBSTANCE_IDENTIFIER.push(j)}a.push(f)}b.ViewModel.SUBSTANCES=a},this.generatePRODUCT=function(){angular.isUndefined(b.ViewModel.PRODUCT)&&(b.ViewModel.PRODUCT={});var a=$("PRODUCT",b.xmlData),c=$(a),d={};d=b.mapOneToOne(c,["PRODUCT_PID","GENERIC_PRODUCT_NAME"]),d.METADATA_STATUS=b.getValue(c.children("METADATA_STATUS"),!1),d.FORMULATION_TYPE=b.getValue(c.children("FORMULATION_TYPE"),!0),d.PRODUCT_RA=[];for(var e=$("PRODUCT_RA",c),f=[],g=0;g<e.length;g++){var h=$(e[g]),i={};i=b.mapOneToOne(h,["PRODUCT_NAME"]),i.REF_RA_Id=b.getReferences(h,"To_Specific_for_RA_Id"),i.forRA=[],i.forRA.push(i.REF_RA_Id),i.RA=b.resolveReceiver(i.REF_RA_Id),i.ADMIN_NUMBER=[];for(var j=[],k=$("ADMIN_NUMBER",h),l=0;l<k.length;l++){var m=$(k[l]),n={};n=b.mapOneToOne(m,["IDENTIFIER"]),n.ADMIN_NUMBER_TYPE=b.getValue(m.children("ADMIN_NUMBER_TYPE"),!0),j.push(n)}i.ADMIN_NUMBER=j,f.push(i)}d.PRODUCT_RA=f,d.INGREDIENTS=[];for(var o=$("INGREDIENTS INGREDIENT",c),p=[],l=0;l<o.length;l++){var q=$(o[l]),r={};r=b.mapOneToOne(q,["QUANTITY"]),r.UNIT=b.getValue(q.children("UNIT"),!0),r.REF_SB_Id=b.getReferences(q,"To_Substance_Id"),r.SUBSTANCE=b.resolveSubstance(r.REF_SB_Id),p.push(r)}d.INGREDIENTS=p,b.ViewModel.PRODUCT=d},this.generateDOSSIER=function(){angular.isUndefined(b.ViewModel.DOSSIER)&&(b.ViewModel.DOSSIER={});var a=$("PRODUCT DOSSIER",b.xmlData),c=$(a),d={};d=b.mapOneToOne(c,["DOSSIER_PID","DOSSIER_DESCRIPTION_TITLE","DOSSIER_COMP_ID"]),d.REFERENCED_DOSSIER=[];for(var e=[],f=$("REFERENCED_DOSSIER",c),g=0;g<f.length;g++){var h=$(f[g]),i={};i=b.mapOneToOne(h,["REFERENCED_DOSSIER_NUMBER","REFERENCED_DOSSIER_REASON"]),e.push(i)}d.REFERENCED_DOSSIER=e,d.DOSSIER_RA=[];for(var j=$("DOSSIER_RA",c),k=[],g=0;g<j.length;g++){var l=$(j[g]),m={};m.REF_RA_Id=b.getReferences(l,"To_Specific_for_RA_Id"),m.forRA=[],m.forRA.push(m.REF_RA_Id),m.RA=b.resolveReceiver(m.REF_RA_Id),m.REGULATORY_TYPE=b.getValue(l.children("REGULATORY_TYPE"),!0),m.APPLICATION_TYPE=b.getValue(l.children("APPLICATION_TYPE"),!0),m.PROJECT_ID_NUMBER=b.makeArray(l.children("PROJECT_ID_NUMBER")),k.push(m)}d.DOSSIER_RA=k,d.SUBMISSIONS=[];for(var n=$("SUBMISSION",c),o=[],g=0;g<n.length;g++){var p=$(n[g]),q={};q=b.mapOneToOne(p,["SUBMISSION_NUMBER","SUBMISSION_VERSION_DATE","SUBMISSION_TITLE","INCREMENTAL"]),o.push(q)}d.SUBMISSIONS=o,b.ViewModel.DOSSIER=d,b.ViewModel.DOSSIER.CurrentSubmission=this.padZero(this.getCurrentSubmission(),2)},this.generateFILES=function(){angular.isUndefined(b.ViewModel.FILES)&&(b.ViewModel.FILES={});for(var a=[],c=$("FILES FILE",b.xmlData),d=0;d<c.length;d++){var e=$(c[d]),f={};f._Id=e.attr("Id"),f.FILE_GENERIC={};var g=$("FILE_GENERIC",e),h=$(g),i={};i=b.mapOneToOne(h,["FILE_PID","FILE_COMPANY_ID","FORMAT_COMMENT","MD5CHECKSUM","FILENAME"]),i.METADATA_STATUS=b.getValue(h.children("METADATA_STATUS"),!1),i.FILE_TYPE=b.getValue(h.children("FILE_TYPE"),!0),i.FILE_CONTENT_STATUS=b.getValue(h.children("FILE_CONTENT_STATUS"),!0),f.FILE_GENERIC=i,f.FILE_RA={};for(var j=$("FILE_RA",e),k=[],l=0;l<j.length;l++){var m=$(j[l]),n={};n=b.mapOneToOne(m,["CBI_DESIGNATION","FILE_COMMENT"]),n.REF_RA_Id=b.getReferences(m,"To_Specific_for_RA_Id"),n.forRA=[],n.forRA.push(n.REF_RA_Id),n.RA=b.resolveReceiver(n.REF_RA_Id),n.METADATA_STATUS=b.getValue(m.children("METADATA_STATUS"),!1),k.push(n)}f.FILE_RA=k,a.push(f)}b.ViewModel.FILES=a},this.generateDOCUMENTS=function(){angular.isUndefined(b.ViewModel.DOCUMENTS)&&(b.ViewModel.DOCUMENTS={});for(var a=$("DOCUMENTS DOCUMENT",b.xmlData),c=[],d=0;d<a.length;d++){var e=$(a[d]),f={};f._Id=e.attr("Id"),f.DOCUMENT_GENERIC={};var g=$("DOCUMENT_GENERIC",e),h=$(g),i={};i=b.mapOneToOne(h,["DOCUMENT_PID","DOCUMENT_FAMILY_PID","DOCUMENT_COMPANY_ID","DOCUMENT_FAMILY","DOCUMENT_TITLE","DOCUMENT_AUTHOR","DOCUMENT_ISSUE_DATE","PUBLISHED_INDICATOR","GXP_INDICATOR","TESTED_ON_VERTEBRATE","COMPLETE_DOCUMENT_SOURCE","DOCUMENT_SOURCE","DOCUMENT_YEAR","DOCUMENT_ISSUE","DOCUMENT_VOLUME","DOCUMENT_PAGES"]),i.METADATA_STATUS=b.getValue(h.children("METADATA_STATUS"),!1),i.DOCUMENT_OWNER=b.makeArray(h.children("DOCUMENT_OWNER")),i.TEST_LABORATORY=b.makeArray(h.children("TEST_LABORATORY")),
// DOCUMENT_CONTENT_STATUS_HISTORY
i.DOCUMENT_CONTENT_STATUS_HISTORY={};for(var j=[],k=h.children("DOCUMENT_CONTENT_STATUS_HISTORY").children(),l=0;l<k.length;l++){var m=$(k[l]),n={};n.SUBMISSION_NUMBER=m.attr("submission_number"),n.DOCUMENT_CONTENT_STATUS=b.getValue(m,!0),j.push(n)}
// fill COMPLETE_DOCUMENT_SOURCE manually, if the choice is DOCUMENT_SOURCE, to simplify sorting
if(i.DOCUMENT_CONTENT_STATUS_HISTORY=j,i.currentStatus=this.getCurrentStatus(i.DOCUMENT_CONTENT_STATUS_HISTORY,b.ViewModel.DOSSIER.CurrentSubmission),!i.COMPLETE_DOCUMENT_SOURCE){var o=i.DOCUMENT_SOURCE;o+=", Year: "+i.DOCUMENT_YEAR,o+=", Issue: "+i.DOCUMENT_ISSUE,o+=", Volume: "+i.DOCUMENT_VOLUME,o+=", Pages: "+i.DOCUMENT_PAGES,i.COMPLETE_DOCUMENT_SOURCE=o}
// will be filled later when TREE is generated
i.toc_refs=[],i.REFERENCED_DOCUMENT=[];for(var p=[],q=$("REFERENCED_DOCUMENT",h),l=0;l<q.length;l++){var r=$(q[l]),s={};s=b.mapOneToOne(r,["INTERNAL","DOCUMENT_PID"]),s.REFERENCE_TYPE=b.getValue(r.children("REFERENCE_TYPE"),!0),s.DOCUMENT_NUMBER={};var t={},u=$("DOCUMENT_NUMBER",r);if(u||u.length>0){var v=$(u);t=b.mapOneToOne(v,["IDENTIFIER"]),t.DOCUMENT_NUMBER_TYPE=b.getValue(v.children("DOCUMENT_NUMBER_TYPE"),!0)}s.DOCUMENT_NUMBER=t,p.push(s)}i.REFERENCED_DOCUMENT=p,i.DOCUMENT_NUMBER=[];for(var w=[],x=h.children("DOCUMENT_NUMBER"),l=0;l<x.length;l++){var v=$(x[l]),y={};y=b.mapOneToOne(v,["IDENTIFIER"]),y.DOCUMENT_NUMBER_TYPE=b.getValue(v.children("DOCUMENT_NUMBER_TYPE"),!0),w.push(y)}i.DOCUMENT_NUMBER=w,i.RELATED_TO_SUBSTANCE=[];for(var z=$("RELATED_TO_SUBSTANCE",h),A=[],l=0;l<z.length;l++){var B=$(z[l]),C={};C.REF_SB_Id=b.getReferences(B,"To_Substance_Id"),C.SUBSTANCE=b.resolveSubstance(C.REF_SB_Id),A.push(C)}i.RELATED_TO_SUBSTANCE=A,i.REFERENCED_TO_FILE={},i.confidentialForRA=[];for(var D=$("REFERENCED_TO_FILE",h),E=[],l=0;l<D.length;l++){var F=$(D[l]),G={};G.REF_FL_Id=b.getReferences(F,"To_File_Id"),G.FILE=b.resolveFile(G.REF_FL_Id),E.push(G),
// main file?
"Main"===G.FILE.FILE_GENERIC.FILE_TYPE&&(i.MAIN_FILE_PATH=G.FILE.FILE_GENERIC.FILENAME,i.MAIN_FILE_ID=G.FILE.FILE_GENERIC._Id);
// for each RA entry in FILE
for(var H=0;H<G.FILE.FILE_RA.length;H++)"true"===G.FILE.FILE_RA[H].CBI_DESIGNATION&&-1==i.confidentialForRA.indexOf(G.FILE.FILE_RA[H].REF_RA_Id)&&i.confidentialForRA.push(G.FILE.FILE_RA[H].REF_RA_Id)}i.REFERENCED_TO_FILE=E,f.DOCUMENT_GENERIC=i,f.DOCUMENT_RA={};for(var I=$("DOCUMENT_RA",e),J=[],l=0;l<I.length;l++){var K=$(I[l]),L={};L.REF_RA_Id=b.getReferences(K,"To_Specific_for_RA_Id"),L.forRA=[],L.forRA.push(L.REF_RA_Id),L.RA=b.resolveReceiver(L.REF_RA_Id),L.METADATA_STATUS=b.getValue(K.children("METADATA_STATUS"),!1),L.DATA_PROTECTION=b.getValue(K.children("DATA_PROTECTION"),!0),L.DATA_REQUIREMENT=b.getValue(K.children("DATA_REQUIREMENT"),!0),L.DOCUMENT_COMMENT=b.makeArray(K.children("DOCUMENT_COMMENT")),L.OTHER_NATIONAL_GUIDELINE={};for(var M=[],N=$("OTHER_NATIONAL_GUIDELINE",K),H=0;H<N.length;H++){var O=$(N[H]),P={};P=b.mapOneToOne(O,["GUIDELINE_SYSTEM","GUIDELINE_NUMBER"]),M.push(P)}L.OTHER_NATIONAL_GUIDELINE=M,L.RA_DOCUMENT_NUMBER={};var Q=$("RA_DOCUMENT_NUMBER",K),R=$(Q),S={};S=b.mapOneToOne(R,["IDENTIFIER","ALREADY_SUBMITTED"]),S.RA_DOCUMENT_NUMBER_TYPE=b.getValue(R.children("RA_DOCUMENT_NUMBER_TYPE"),!0),S.DOSSIER_CONTEXT={};for(var T=$("DOSSIER_CONTEXT",R),U=[],H=0;H<T.length;H++){var V=$(T[H]),W={};W=b.mapOneToOne(V,["DOSSIER_PID","DOSSIER_NUMBER"]),U.push(W)}S.DOSSIER_CONTEXT=U,L.RA_DOCUMENT_NUMBER=S,
// RA-specific FILE Information
L.FILEINFO={};for(var X=[],H=0;H<f.DOCUMENT_GENERIC.REFERENCED_TO_FILE.length;H++){
// get the data needed to resolve FileRA information
var Y=f.DOCUMENT_GENERIC.REFERENCED_TO_FILE[H].FILE,Z=L.REF_RA_Id,_=this.resolveFileInfoPerRA(Y,Z),aa={};if(_){
// get RA specific information
aa.cbi="true"===_.CBI_DESIGNATION,aa.comment=_.FILE_COMMENT,
// get RA-independent information
aa.filetype=Y.FILE_GENERIC.FILE_TYPE;var ba=Y.FILE_GENERIC.FILENAME;aa.filepath=ba,aa.shortfilename=ba.substr(ba.lastIndexOf("/")+1),aa.mimetype=aa.shortfilename.substr(aa.shortfilename.lastIndexOf(".")+1),aa.companyid=Y.FILE_GENERIC.FILE_COMPANY_ID,aa.formatcomment=Y.FILE_GENERIC.FORMAT_COMMENT,aa.pid=Y.FILE_GENERIC.FILE_PID,
// Removed in 01.02.00
//file['replacedfilepid'] = FILE['FILE_GENERIC']['REPLACED_FILE_PID'];
//file['replacedpid'] = FILE['FILE_GENERIC']['REPLACED_FILE_PID'];
// Removed with CR 11
//file.status = FILE.FILE_GENERIC.FILE_CONTENT_STATUS;
X.push(aa)}}L.FILEINFO=X,J.push(L)}f.DOCUMENT_RA=J,c.push(f)}b.ViewModel.DOCUMENTS=c},this.generateDOCLIST=function(){angular.isUndefined(b.ViewModel.DOCLIST)&&(b.ViewModel.DOCLIST={});for(var a=[],c=0;c<b.ViewModel.DOCUMENTS.length;c++){var d=b.ViewModel.DOCUMENTS[c],e={};e=b.copyByValue(d.DOCUMENT_GENERIC,["METADATA_STATUS","DOCUMENT_TITLE","DOCUMENT_AUTHOR","DOCUMENT_ISSUE_DATE","PUBLISHED_INDICATOR","GXP_INDICATOR","TESTED_ON_VERTEBRATE","DOCUMENT_COMPANY_ID","DOCUMENT_NUMBER","TEST_LABORATORY","DOCUMENT_OWNER","COMPLETE_DOCUMENT_SOURCE","DOCUMENT_SOURCE","DOCUMENT_YEAR","DOCUMENT_ISSUE","DOCUMENT_VOLUME","DOCUMENT_PAGES"]),e.Id=d._Id,e.forRA=[];for(var f=0;f<d.DOCUMENT_RA.length;f++)e.forRA.push(d.DOCUMENT_RA[f].REF_RA_Id);e.name=e.DOCUMENT_TITLE,e.confidentialForRA=d.DOCUMENT_GENERIC.confidentialForRA,e.currentStatus=d.DOCUMENT_GENERIC.currentStatus,e.retired="Retired"===e.currentStatus,e.lastChange=this.getLastChange(d.DOCUMENT_GENERIC.DOCUMENT_CONTENT_STATUS_HISTORY),e.toc_refs=[],a.push(e)}b.ViewModel.DOCLIST=a},this.generateFILTER=function(){angular.isUndefined(b.ViewModel.FILTER)&&(b.ViewModel.FILTER={});for(var a=[],c=$("RECEIVERS RECEIVER",b.xmlData),d=0;d<c.length;d++){var e=$(c[d]),f={};f.Id=e.attr("Id"),f.Name=e.children("SHORT_NAME").text(),a.push(f)}for(var g=[],h=$("PRODUCT DOSSIER SUBMISSION",b.xmlData),d=1;d<h.length;d++){var i=$(h[d]),j="";j=i.children("SUBMISSION_NUMBER").text(),g.push(j)}b.ViewModel.FILTER.RAs=a,b.ViewModel.FILTER.Submissions=g},this.generateTOC=function(){function a(a){var c={};return c=b.mapOneToOne(a,["NODE_NAME","NODE_HEADING","TOC_NODE_PID","EMPTY_NODE"])}function c(a){for(var c=[],d=a.children("TOC2DOC"),e=0;e<d.length;e++){var f=$(d[e]),g={};g.NODE_ASSIGNMENT_STATUS=b.getValue(f.children("NODE_ASSIGNMENT_STATUS"),!1),g.REF_DOC_Id=f.attr("To_Document_Id"),g.document=b.resolveDocument(g.REF_DOC_Id),c.push(g)}return c}function d(b){for(var g=[],h=b.children("TOC_NODE"),i=0;i<h.length;i++){var j=$(h[i]),k={};k=a(j),k.TOC_NODE=[],k.TOC_NODE=d(j),k.TOC2DOC=[],k.TOC2DOC=c(j),g.push(k),f[e]={},f[e].nodename=k.NODE_NAME,f[e].docs=[];for(var l=0;l<k.TOC2DOC.length;l++)f[e].docs.push(k.TOC2DOC[l].document._Id);e++}return g}angular.isUndefined(b.ViewModel.TOC)&&(b.ViewModel.TOC={});var e=0,f=[],g=$("TOC",b.xmlData),h=$(g),i={};i=b.mapOneToOne(h,["TOC_SHORT_NAME","TOC_FULL_NAME","TOC_VERSION"]),i.METADATA_STATUS=b.getValue(h.children("METADATA_STATUS"),!1),i.TOC_OWNER=b.getValue(h.children("TOC_OWNER"),!0),i.STANDARD_TOC_REFERENCE={},i.STANDARD_TOC_REFERENCE=b.mapOneToOne(h.children("STANDARD_TOC_REFERENCE"),["STANDARD_TOC_PID","FILENAME"]),i.STRUCTURE={},i.INDEX={};var j=$(h.children("STRUCTURE")),k=d(j);i.STRUCTURE=k,i.INDEX=f,b.ViewModel.TOC=i},this.generateTREE=function(){function a(e){for(var f=[],g=0;g<e.length;g++){var h={};h.type="NODE",h.id=e[g].TOC_NODE_PID,h.nodeIndex=d++,h.title=e[g].NODE_HEADING,h.name=e[g].NODE_NAME,h.children=[],h.children=a(e[g].TOC_NODE);for(var i=[],j=0;j<e[g].TOC2DOC.length;j++){var k={};k.type="DOC",k.docIndex=c++,k.nodeIndex=d++,k.id=e[g].TOC2DOC[j].REF_DOC_Id,
// Change in 01.02.00 - NODE_ASSIGNMENT_STATUS added
k.assignmentStatus=e[g].TOC2DOC[j].NODE_ASSIGNMENT_STATUS;var l=b.resolveDocument(k.id);l.DOCUMENT_GENERIC.toc_refs.push({name:h.name,id:k.id,index:k.docIndex,assignmentStatus:k.assignmentStatus});var m=b.resolveDocumentInList(k.id);m.toc_refs.push({name:h.name,id:k.id,index:k.docIndex,assignmentStatus:k.assignmentStatus}),k.title=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_AUTHOR+" ("+e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_ISSUE_DATE+")",k.name=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_TITLE,
// filter attributes
k.parentName=h.name,k.ISSUE_DATE=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_ISSUE_DATE,k.DOCUMENT_COMPANY_ID=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_COMPANY_ID,k.DOCUMENT_NUMBER=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_NUMBER,k.DOCUMENT_AUTHOR=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_AUTHOR,k.DOCUMENT_OWNER=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_OWNER,k.TEST_LABORATORY=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.TEST_LABORATORY,
// SOURCE info
k.COMPLETE_DOCUMENT_SOURCE=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.COMPLETE_DOCUMENT_SOURCE,k.DOCUMENT_SOURCE=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_SOURCE,k.DOCUMENT_YEAR=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_YEAR,k.DOCUMENT_ISSUE=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_ISSUE,k.DOCUMENT_VOLUME=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_VOLUME,k.DOCUMENT_PAGES=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_PAGES,k.forRA=[];for(var n=0;n<e[g].TOC2DOC[j].document.DOCUMENT_RA.length;n++)k.forRA.push(e[g].TOC2DOC[j].document.DOCUMENT_RA[n].REF_RA_Id);k.confidentialForRA=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.confidentialForRA,k.currentStatus=e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.currentStatus,k.retired="Retired"===k.currentStatus,k.lastChange=b.getLastChange(e[g].TOC2DOC[j].document.DOCUMENT_GENERIC.DOCUMENT_CONTENT_STATUS_HISTORY),k.children=[],i.push(k)}
// show documents first in nodes
h.children=i.concat(h.children),f.push(h)}return f}angular.isUndefined(b.ViewModel.TREE)&&(b.ViewModel.TREE={});var c=0,d=0,e=[],f={};
// we don't need a title as the short name is sufficient for the name
f.title=b.ViewModel.TOC.TOC_FULL_NAME,//self.ViewModel.TOC.TOC_SHORT_NAME;
f.name=b.ViewModel.TOC.TOC_SHORT_NAME,f.type="TOC",f.nodeIndex=d++,f.children=a(b.ViewModel.TOC.STRUCTURE),e.push(f),e.nodeCount=d,e.docCount=c,b.ViewModel.TREE=e},this.generateINFO=function(){angular.isUndefined(b.ViewModel.INFO)&&(b.ViewModel.INFO={});var a={};a.submission=b.ViewModel.DOSSIER.CurrentSubmission,a.currentpath=b.getSubmissionPath(window.location.href,3)+"ghsts.xml",a.specversion=b.xmlData.filter(":first").attr("specificationversion"),a.shortname=b.ViewModel.TOC.TOC_SHORT_NAME,a.tocversion=b.ViewModel.TOC.TOC_VERSION,a.tocstatus=b.ViewModel.TOC.METADATA_STATUS,angular.isDefined(parent.viewerAPI)?(a.nwversion=parent.viewerAPI.getVersions().nodeWebkit,a.viewerversion=parent.viewerAPI.getVersions().desktopViewer):(a.nwversion="not available",a.viewerversion="not available"),a.angularversion=angular.version,a.jqueryversion=jQuery.fn.jquery,b.ViewModel.INFO=a},
// HELPER functions
this.mapOneToOne=function(a,b){if(!a)return[];if(!b||0===b.length)return[];for(var c={},d=0;d<b.length;d++){var e=b[d],f=a.children(e),g=f&&0!==f.length?f.text():"";c[e]=g}return c},this.makeArray=function(a){if(!a||0===a.length)return[];for(var b=[],c=0;c<a.length;c++){var d=$(a[c]).text();b.push(d)}return b},this.getValue=function(a,b){if(!a)return"";if(b)return a.children("VALUE_DECODE").text()||"";var c=a.children("VALUE").text()||"";return"OTHER"===c.toUpperCase()?a.children("VALUE").attr("Other_Value")||"":c},this.getReferences=function(a,b){if(!a||!b)return"";var c=a.attr(b);return c},this.getCurrentSubmission=function(){for(var a=0,c=0;c<b.ViewModel.DOSSIER.SUBMISSIONS.length;c++)parseInt(b.ViewModel.DOSSIER.SUBMISSIONS[c].SUBMISSION_NUMBER)>a&&(a=parseInt(b.ViewModel.DOSSIER.SUBMISSIONS[c].SUBMISSION_NUMBER));return a},this.getLastChange=function(a){for(var b=0,c="",d=0;d<a.length;d++){var e=a[d];parseInt(e.SUBMISSION_NUMBER)>b&&("NEW"===e.DOCUMENT_CONTENT_STATUS.toUpperCase()||"REPLACE"===e.DOCUMENT_CONTENT_STATUS.toUpperCase()||"MODIFIED"===e.DOCUMENT_CONTENT_STATUS.toUpperCase()||"RETIRED"===e.DOCUMENT_CONTENT_STATUS.toUpperCase())&&(b=parseInt(e.SUBMISSION_NUMBER),c=e.DOCUMENT_CONTENT_STATUS)}return b>0&&c.length>0?{Submission:this.padZero(b,2),Status:c}:{Submission:null,Status:""}},this.getCurrentStatus=function(a,b){
// check history from newest to oldest to find current submission status
for(var c=a.length-1;c>=0;c--)if(parseInt(a[c].SUBMISSION_NUMBER)===parseInt(b)){for(var d=c;d>=0&&"New"!==a[d].DOCUMENT_CONTENT_STATUS;d--)if("Retired"===a[d].DOCUMENT_CONTENT_STATUS)return a[d].DOCUMENT_CONTENT_STATUS;return a[c].DOCUMENT_CONTENT_STATUS}return"No Change"},this.combineMetadataStatus=function(a,b){return"No Change"===a?b:"No Change"===b?a:b===a?b:"unkown"},this.copyByValue=function(a,b){if(!a||!b)return{};for(var c={},d=0;d<b.length;d++)c[b[d]]=a[b[d]];return c},this.padZero=function(a,b){// change to string
for(var c=a+"";c.length<b;)c="0"+c;//add leading zero until total size is reached
return c},
// RESOLVER
this.resolveReceiver=function(a){if(!a||!b.ViewModel.RECEIVERS)return{};for(var c=0;c<b.ViewModel.RECEIVERS.length;c++)if(b.ViewModel.RECEIVERS[c]._Id===a)return b.ViewModel.RECEIVERS[c];return{}},this.resolveLegalEntity=function(a){if(!a||!b.ViewModel.LEGAL_ENTITIES)return{};for(var c=0;c<b.ViewModel.LEGAL_ENTITIES.length;c++)if(b.ViewModel.LEGAL_ENTITIES[c]._Id===a)return b.ViewModel.LEGAL_ENTITIES[c];return{}},this.resolveSubstance=function(a){if(!a||!b.ViewModel.SUBSTANCES)return{};for(var c=0;c<b.ViewModel.SUBSTANCES.length;c++)if(b.ViewModel.SUBSTANCES[c]._Id===a)return b.ViewModel.SUBSTANCES[c];return{}},this.resolveFile=function(a){if(!a||!b.ViewModel.FILES)return{};for(var c=0;c<b.ViewModel.FILES.length;c++)if(b.ViewModel.FILES[c]._Id===a)return b.ViewModel.FILES[c];return{}},this.resolveDocument=function(a){if(!a||!b.ViewModel.DOCUMENTS)return{};for(var c=0;c<b.ViewModel.DOCUMENTS.length;c++)if(b.ViewModel.DOCUMENTS[c]._Id===a)return b.ViewModel.DOCUMENTS[c];return{}},this.resolveDocumentInList=function(a){if(!a||!b.ViewModel.DOCLIST)return{};for(var c=0;c<b.ViewModel.DOCLIST.length;c++)if(b.ViewModel.DOCLIST[c].Id===a)return b.ViewModel.DOCLIST[c];return{}},this.resolveFileInfoPerRA=function(a,b){
//var file = this.resolveFile(file);
for(var c=0;c<a.FILE_RA.length;c++)if(a.FILE_RA[c].REF_RA_Id===b)return a.FILE_RA[c];return null},this.init=function(){
// Load and Parse ghsts-xml-file
b.xmlData=a.getData(),console.debug("Start XML parse: "+Date.now()),b.generateViewModel(),console.debug("Finished XML parse: "+Date.now())},
// KEEP
this.getViewModel=function(a,c){if(!a)return{};switch(a){case"filter":return b.ViewModel.FILTER;case"partners":return b.ViewModel.RECEIVERS;case"product":return b.ViewModel.PRODUCT;case"dossier":return b.ViewModel.DOSSIER;case"info":return b.ViewModel.INFO;case"doclist":return b.ViewModel.DOCLIST;case"documents":return b.ViewModel.DOCUMENTS;case"filelist":return b.ViewModel.FILELIST;case"tree":return{tree:b.ViewModel.TREE};case"document":return b.resolveDocument(c);default:return{}}},this.setViewModel=function(a,c){b.ViewModel[a]=c}}])}(),function(){"use strict";function a(a){
////////////
function b(){return o()[0]}
// will return ONE or MORE!!!
function c(a){function b(d){if("DOC"===d.type)d.id===a&&c.push(d);else for(var e=0;e<d.children.length;e++)b(d.children[e])}var c=[];return b(o()[0]),c}
// will return just ONE!
function d(a){function b(c){if("DOC"===c.type)return c.docIndex===a?c:null;for(var d=0;d<c.children.length;d++){var e=b(c.children[d]);if(e)return e}return null}0>a&&(a=o().docCount-1),a>o().docCount-1&&(a=0);var c=b(o()[0]);return c?c:null}function e(a){var b=q();if(b&&b.length>0)for(var c=0;c<b.length;c++)if(b[c].Id===a)return b[c].isVisible;return!0}function f(a){if("DOC"===a.type)
// property isVisible is undefined on initial load
// property isVisible is undefined on initial load
return"undefined"==typeof a.isVisible||a.isVisible?a:void 0;
// whole TOC nodes are invisible, if the current document count is 0
if(0!==a.docCount){for(var b=[],c=0;c<a.children.length;c++){var d=f(a.children[c]);d&&(b=b.concat(d))}return b}}function g(a){if(0>a||a>o().docCount-1)return!1;var b=f(o()[0]);return!(!b||!b[b.length-1]||b[b.length-1].docIndex===a)}function h(a){if(0>a||a>o().docCount-1)return!1;var b=f(o()[0]);return!(!b||!b[0]||b[0].docIndex===a)}function i(a){function b(d){if("DOC"===d.type){if(d.docIndex===a)return c.push(d),!0}else for(var e=0;e<d.children.length;e++){var f=b(d.children[e]);if(f)return c.push(d),!0}}var c=[];return b(o()[0]),c}function j(a){if(!a||!p())return{};for(var b=0;b<p().length;b++)if(p()[b]._Id===a)return p()[b];return{}}function k(){var b=q();if(b&&b.length>0)for(var c=0;c<b.length;c++)if(b[c].isVisible)return a.resolveDocument(b[c].Id);return null}function l(a){return n(a,q(),!1)}function m(a){return n(a,q(),!0)}
// find the next or previous element by ID in a given document list
function n(b,c,d){
// go through all documents
for(var e=c.length,f=0;e>f;f++)
// if current document found
if(c[f].Id===b){
// identify potential next (in list)
var g=f,h=g;do if(d?(h--,0>h&&(h=e-1)):(h++,h>=e&&(h=0)),c[h].isVisible)return a.resolveDocument(c[h].Id);while(h!==g);break}
// there is no visible list item
return null}function o(){return a.getViewModel("tree").tree}function p(){return a.getViewModel("documents")}function q(){return a.getViewModel("doclist")}
// Public Interface
var r={getTopTreeNode:b,getDocNodesById:c,getDocNodeByIndex:d,getNodePathOfDoc:i,getDocumentById:j,getFirstDocumentInTable:k,getNextDocumentInTable:l,getPrevDocumentInTable:m,hasNextDocumentInTOC:g,hasPrevDocumentInTOC:h,isDocumentVisible:e};return r}angular.module("ghsts-model").service("GhstsModelNavigation",a),a.$inject=["GhstsModelData"]}(),function(){var a=angular.module("ghsts-state-service",["ghsts-model","ghsts-util"]);a.service("GhstsStateService",["$rootScope","GhstsModelData","GhstsModelNavigation","GhstsViewerFilter","$location","$anchorScroll","$timeout","hotkeys","BookmarkService","CONFIG","UtilService",function(a,b,c,d,e,f,g,h,i,j,k){function l(){o.State.Detail.currentDocument=void 0,o.clearOpenDocumentFiles(),o.State.Tree.selectedNode=void 0}function m(b){function c(a){o.setTreeSelected(a),o.setDetailDocumentById(a),"TABLE"===o.State.Viewer.StructureView&&"DOCUMENT"!==o.State.Viewer.DetailView&&o.triggerScroll("TABLE"+a)}a.$$phase?c(b):a.$apply(function(){c(b)})}function n(a){o.setViewerState(a.view),m(a.docId),o.setTreeSelected(a.docId,a.docIndex),
// TODO apply filter 
o.deselectElementOnFilter()}var o=this;
// Public Interface
/* Define hotkeys for state navigation */
// Viewer States
// Tree States
// Detail States
// General Methods
return h.add({combo:"ctrl+up",description:"Previous Document",callback:function(){console.log("ctrl+up pressed"),o.setPrev(o.State.Viewer.StructureView)}}),h.add({combo:"ctrl+down",description:"Next Document",callback:function(){console.log("ctrl+down pressed"),o.setNext(o.State.Viewer.StructureView)}}),h.add({combo:"ctrl+left",description:"Collapse nodes",callback:function(){"TOC"===o.State.Viewer.StructureView&&o.setTreeCollapsed()}}),h.add({combo:"ctrl+right",description:"Expand nodes",callback:function(){"TOC"===o.State.Viewer.StructureView&&o.setTreeExpanded()}}),o.triggerScroll=function(a){o.gotoAnchor("",""),g(function(){o.gotoAnchor(a,"")},0)},o.gotoAnchor=function(a,b){var c=a+b;e.hash()!==c?
// set the $location.hash to `newHash` and
// $anchorScroll will automatically scroll to it
e.hash(a+b):
// call $anchorScroll() explicitly,
// since $location.hash hasn't changed
f()},o.defineViewerStates=function(){return{TOC:{StructureView:"TOC",DetailView:"DOCUMENT",NavigateView:!0,ToggleView:!0},NODE:{StructureView:"TOC",DetailView:"NODE",NavigateView:!0,ToggleView:!0},TABLE:{StructureView:"TABLE",DetailView:"DOCUMENT",NavigateView:!0,ToggleView:!1},DOSSIER:{StructureView:null,DetailView:"DOSSIER",NavigateView:null,ToggleView:null},PRODUCT:{StructureView:null,DetailView:"PRODUCT",NavigateView:null,ToggleView:null},PARTNERS:{StructureView:null,DetailView:"PARTNERS",NavigateView:!0,ToggleView:null},INFO:{StructureView:null,DetailView:"INFO",NavigateView:null,ToggleView:null}}},o.resolveViewerState=function(a){return a in o.ViewerStates?o.ViewerStates[a]:{StructureView:null,DetailView:null,NavigateView:null,ToggleView:null}},o.setViewerState=function(a){var b=o.resolveViewerState(a);null!==b.StructureView&&b.StructureView!==o.State.Viewer.StructureView&&(o.State.Viewer.StructureView=b.StructureView,o.State.Detail.currentDocument&&o.gotoAnchor(b.StructureView,o.State.Detail.currentDocument._Id)),o.State.Viewer.DetailView=null===b.DetailView?o.State.Viewer.DetailView:b.DetailView,o.State.Viewer.NavigateView=null===b.NavigateView?o.State.Viewer.NavigateView:b.NavigateView,o.State.Viewer.ToggleView=null===b.ToggleView?o.State.Viewer.ToggleView:b.ToggleView,
// deselect the current element, if the view doesn't show a specific element in detail (general vs. detail views)
null===b.StructureView&&l()},o.setTreeExpanded=function(){function a(b){if(Array.isArray(b.children)){o.State.Tree.expandedNodes.push(b);for(var c=0;c<b.children.length;c++)a(b.children[c])}}o.State.Tree.expandedNodes=[],a(c.getTopTreeNode())},o.setTreeCollapsed=function(){o.State.Tree.selectedNode&&(o.State.Tree.expandedNodes=c.getNodePathOfDoc(o.State.Tree.selectedNode.docIndex))},o.setTreeSelected=function(a,b){if(b>=0){var d=c.getDocNodeByIndex(b);o.State.Tree.selectedNode=d}else{var e=c.getDocNodesById(a);
// take the first Document only
o.State.Tree.selectedNode=e[0]}o.State.Tree.expandedNodes=c.getNodePathOfDoc(o.State.Tree.selectedNode.docIndex)},o.setDetailDocumentById=function(a){o.State.Detail.currentDocument=c.getDocumentById(a),o.clearOpenDocumentFiles()},o.setDetailDocument=function(a){o.State.Detail.currentDocument=a,o.clearOpenDocumentFiles()},o.clearOpenDocumentFiles=function(){o.State.Detail.openFiles=[]},o.openFileFromDocument=function(a){o.State.Detail.openFiles||o.clearOpenDocumentFiles();for(var b=!1,c=0,d=0;d<o.State.Detail.openFiles.length;d++){var e=o.State.Detail.openFiles[d];if(e.path===a.path){b=!0;break}
// find correct insert position
a.id>=e.id&&(c=d+1)}b||(c===a.length?o.State.Detail.openFiles.push(a):o.State.Detail.openFiles.splice(c,0,a))},o.setNext=function(a){switch(a){case"TOC":if(!o.State.Tree.selectedNode)return;var b=o.State.Tree.selectedNode.docIndex;do{var d=o.State.Tree.selectedNode.docIndex+1;o.State.Tree.selectedNode=c.getDocNodeByIndex(d)}while(!o.State.Tree.selectedNode.isVisible&&o.State.Tree.selectedNode.docIndex!==b);o.State.Tree.expandedNodes=c.getNodePathOfDoc(o.State.Tree.selectedNode.docIndex),o.setDetailDocument(c.getDocumentById(o.State.Tree.selectedNode.id));break;case"TABLE":o.State.Detail.currentDocument?o.setDetailDocument(c.getNextDocumentInTable(o.State.Detail.currentDocument._Id)):o.setDetailDocument(c.getFirstDocumentInTable()),o.setTreeSelected(o.State.Detail.currentDocument._Id)}o.setViewerState(a),o.gotoAnchor(o.State.Viewer.StructureView,o.State.Detail.currentDocument._Id)},o.setPrev=function(a){switch(a){case"TOC":if(!o.State.Tree.selectedNode)return;var b=o.State.Tree.selectedNode.docIndex;do{var d=o.State.Tree.selectedNode.docIndex-1;o.State.Tree.selectedNode=c.getDocNodeByIndex(d)}while(!o.State.Tree.selectedNode.isVisible&&o.State.Tree.selectedNode.docIndex!==b);o.State.Tree.expandedNodes=c.getNodePathOfDoc(o.State.Tree.selectedNode.docIndex),o.setDetailDocument(c.getDocumentById(o.State.Tree.selectedNode.id));break;case"TABLE":o.State.Detail.currentDocument?o.setDetailDocument(c.getPrevDocumentInTable(o.State.Detail.currentDocument._Id)):o.setDetailDocument(c.getFirstDocumentInTable()),o.setTreeSelected(o.State.Detail.currentDocument._Id)}o.setViewerState(a),o.gotoAnchor(o.State.Viewer.StructureView,o.State.Detail.currentDocument._Id)},o.hasNextElement=function(){switch(o.State.Viewer.StructureView){case"TOC":return o.State.Tree.selectedNode?c.hasNextDocumentInTOC(o.State.Tree.selectedNode.docIndex):!1;case"TABLE":if(!o.State.Detail.currentDocument)return!1;var a=c.getNextDocumentInTable(o.State.Detail.currentDocument._Id),b=c.getFirstDocumentInTable();return!a||!b||a._Id!==b._Id}return!1},o.hasPrevElement=function(){switch(o.State.Viewer.StructureView){case"TOC":return o.State.Tree.selectedNode?c.hasPrevDocumentInTOC(o.State.Tree.selectedNode.docIndex):!1;case"TABLE":if(!o.State.Detail.currentDocument)return!1;var a=c.getFirstDocumentInTable();return!a||o.State.Detail.currentDocument._Id!==a._Id}return!1},o.setTablestate=function(a){o.State.Tablestate=a,o.State.TableSortstate=a.sort,o.State.Detail.currentDocument&&o.triggerScroll("TABLE"+o.State.Detail.currentDocument._Id)},o.deselectElementOnFilter=function(){
// check if document is still visible in filtered list
// deselect the current document if it is not visible anymore
"undefined"!=typeof o.State.Detail.currentDocument&&(c.isDocumentVisible(o.State.Detail.currentDocument._Id)||l())},o.initState=function(){
// handles messages to this window to support content export from DesktopViewer
window.addEventListener("message",function(a){var c=a.data;"undefined"!=typeof c.sender&&"ghsts-desktop-viewer"===c.sender&&("select-document"===c.type?
// select sent document as active one
o.selectDocumentByIdFromExternalAction(a.document._Id):"export"===c.type?
// send the current model data to the DesktopViewer for export
angular.isDefined(parent.viewerAPI)&&parent.viewerAPI.exportFiles(b.getViewModel("dossier"),b.getViewModel("tree"),b.getViewModel("documents"),k.getSubmissionPath()):"init-bookmarks"===c.type&&i.load(c.bookmarks))});var a=c.getDocNodeByIndex(0),d=o.resolveViewerState("TOC");return{Viewer:{StructureView:d.StructureView,DetailView:d.DetailView,ToggleView:d.ToggleView,NavigateView:d.NavigateView},Tree:{expandedNodes:a?c.getNodePathOfDoc(a.docIndex):[],selectedNode:a?a:{}},Detail:{currentDocument:a?c.getDocumentById(a.id):null}}},o.selectDocumentByIdFromExternalAction=function(a){
// check if selected document is not available or currently filtered
var c=b.getViewModel("doclist");console.log(c);var e;c.forEach(function(b){b.Id===a&&(e=b)}),e?e&&!e.isVisible?bootbox.dialog({message:"The selected document '"+a+"' is not part of the current display set due to the currently applied filter criteria. Should the filter be removed?",title:"Document not part of the display set",buttons:{warning:{label:"Remove filter",className:"btn-danger",callback:function(){d.initFilter(),m(a)}},main:{label:"Cancel",className:"btn-primary"}}}):m(a):bootbox.alert("Selected document with id "+a+" not found!")},o.getState=function(){return o.State},o.init=function(){
// Constructor Code
o.ViewerStates=o.defineViewerStates(),o.State=o.initState()},{init:o.init,getState:o.getState,setViewerState:o.setViewerState,setTreeExpanded:o.setTreeExpanded,setTreeCollapsed:o.setTreeCollapsed,setTreeSelected:o.setTreeSelected,setDetailDocumentById:o.setDetailDocumentById,selectDocumentByIdFromExternalAction:o.selectDocumentByIdFromExternalAction,openFileFromDocument:o.openFileFromDocument,restoreHistoryState:n,setNext:o.setNext,setPrev:o.setPrev,hasNextElement:o.hasNextElement,hasPrevElement:o.hasPrevElement,setTablestate:o.setTablestate,getTablestate:o.getTablestate,deselectElementOnFilter:o.deselectElementOnFilter}}])}(),function(){"use strict";function a(a,b,c){
////////////
/*
     * functions needed by the pdf.js
     * to interact with the HTML-Viewer
     */
function d(){window.pdfViewerAPI={openPdfGhstsLink:f,getPdfGhstsLinkedDocument:g,openPdfGhstsGoToRLink:j,getPdfGhstsLinkedGoToRDocument:k}}function e(b){var c,d=b.replace("ghsts://",""),e=a.getViewModel("documents");return e.forEach(function(a){a.DOCUMENT_GENERIC.DOCUMENT_PID===d&&(c=a)}),c}function f(a){console.log("open: "+a);
// TODO parse link for specific options (e.g. 'external')
// if document could not be found, send to DesktopViewer
var c=g(a);if(c)b.selectDocumentByIdFromExternalAction(c._Id);else{var d=!1;window.parent.viewerAPI&&(
// evaluate result of Desktop Viewer - could document be found?!
d=window.parent.viewerAPI.openPdfGhstsLink(a)),"undefined"!=typeof window.parent.viewerAPI&&d||bootbox.alert("Document for link "+a+" not found!")}}function g(a){return e(a)}function h(a){var b=a.replace(/\//g,"\\").split("\\");return b.splice(b.length-1,1),b.join("/")+"/"}function i(c){
// get current main file
var d=b.getState().Detail.currentDocument,e=d.DOCUMENT_GENERIC.MAIN_FILE_PATH,f=h(e),g=f+c;
// normalize paths with path utils in desktop viewer
"undefined"!=typeof window.parent.viewerAPI&&(g=window.parent.viewerAPI.normalizePath(g));var i,j=a.getViewModel("documents");return j.forEach(function(a){var b=a.DOCUMENT_GENERIC.MAIN_FILE_PATH;"undefined"!=typeof window.parent.viewerAPI&&(b=window.parent.viewerAPI.normalizePath(b)),b===g&&(i=a)}),i}function j(a){console.log("openGoToRLink: "+a);var c=k(a);c&&b.selectDocumentByIdFromExternalAction(c._Id)}function k(a){return i(a)}
// public API
var l={init:d,openLink:f};return l}angular.module("GhstsViewer").service("PdfLinkService",a),a.$inject=["GhstsModelData","GhstsStateService","GhstsViewerFilter"]}(),function(){"use strict";function a(a,b,c){var d=this;d.modelLoaded=!1,d.tocLoaded=!1,d.useAnnotations=c.USE_ANNOTATIONS}angular.module("ghsts-main",["ghsts-model","ui.layout"]).controller("MainController",a),a.$inject=["$scope","GhstsModelData","CONFIG"]}(),function(){"use strict";function a(){return function(a,b,c){
// model data is loaded at this point
a.mainCtrl.modelLoaded=!0}}angular.module("ghsts-main").directive("mainLoaded",a)}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){m.hasNextElement=e.hasNextElement(),m.hasPrevElement=e.hasPrevElement()}function h(){m.isTreeElementSelected=angular.isDefined(m.State.Tree.selectedNode)}
////////////
function i(a){e.setViewerState(a),g()}function j(){m.isTreeElementSelected&&e.setTreeCollapsed()}function k(){e.hasNextElement()&&(e.setNext(m.State.Viewer.StructureView),m.hasNextElement=e.hasNextElement())}function l(){e.hasPrevElement()&&(e.setPrev(m.State.Viewer.StructureView),m.hasPrevElement=e.hasPrevElement())}var m=this;m.State=e.getState(),m.docdata=[],m.fullDocCount=d.getViewModel("doclist").length,m.Filter=f.getFilter(),m.changeState=i,m.expandAll=function(){e.setTreeExpanded()},m.collapseAll=j,m.showNext=k,m.showPrev=l,m.isFilterActive=f.isFilterActive,m.clearFilter=f.initFilter,g(),h(),a.$watch("menuCtrl.State.Detail.currentFile",g),a.$watch("menuCtrl.State.Detail.currentDocument",g),a.$watch("menuCtrl.State.TableSortstate",g,!0),a.$watch("menuCtrl.State.Tree.selectedNode",function(){h(),g()}),a.$watch("menuCtrl.Filter",function(){m.docdata=c("setListVisibilityFilter")(d.getViewModel("doclist")),"undefined"!=typeof m.State.Detail.currentDocument&&g(),"undefined"!=typeof m.State.Tree.selectedNode&&
// wait for tree to finish render on changed filter
b(g,0)},!0)}angular.module("ghsts-controller-menu",["ghsts-model","ghsts-state-service"]).controller("MenuController",a),a.$inject=["$scope","$timeout","$filter","GhstsModelData","GhstsStateService","GhstsViewerFilter"]}(),function(){"use strict";function a(a,b,c,d){
////////////
function e(a){m=void 0,o>=0&&o<n.length-1&&n.splice(o+1,n.length-o+1),n.push(a),n.length>d.HISTORY_SIZE&&n.splice(0,1),o=n.length-1,j()}function f(){
// only react to change if the state view is _NOT_ ToC
"TOC"!==q.Viewer.StructureView&&q.Detail.currentDocument&&(
// ignore the selection, if we triggered it ourselves
m&&m.docId===q.Detail.currentDocument._Id&&m.docIndex===q.Tree.selectedNode.docIndex||
// TODO save Filter settings
e({view:"TABLE",docId:q.Detail.currentDocument._Id,docIndex:q.Tree.selectedNode.docIndex}))}function g(){
// only react to change if the state view is ToC
"TOC"===q.Viewer.StructureView&&q.Detail.currentDocument&&(
// ignore the selection, if we triggered it ourselves
m&&m.docId===q.Tree.selectedNode.id&&m.docIndex===q.Tree.selectedNode.docIndex||
// TODO save Filter settings
e({view:"TOC",docId:q.Tree.selectedNode.id,docIndex:q.Tree.selectedNode.docIndex}))}function h(){if(p.hasNext){o++;var a=n[o];m=a,c.restoreHistoryState(a),j()}}function i(){if(p.hasPrevious){0>o?o=n.length-1:o--;var a=n[o];m=a,c.restoreHistoryState(a),j()}}function j(){k(),l()}function k(){return n.length<=1?void(p.hasNext=!1):0>o?void(p.hasNext=!1):o===n.length-1?void(p.hasNext=!1):void(p.hasNext=!0)}function l(){return n.length<=1?void(p.hasPrevious=!1):0>o&&n.length>0?void(p.hasPrevious=!0):o>0?void(p.hasPrevious=!0):void(p.hasPrevious=!1)}
// stack for state organization
var m,n=[],o=-1,p={hasNext:!1,hasPrevious:!1},q=c.getState();a.modelState=q,a.$watch("modelState.Detail.currentDocument",f),a.$watch("modelState.Tree.selectedNode",g);
// public API
var r={showNext:h,showPrevious:i,getNavigateState:function(){return p}};return r}angular.module("ghsts-history",["ghsts-model","ghsts-state-service","ghsts-constants"]).service("HistoryService",a),a.$inject=["$rootScope","GhstsModelData","GhstsStateService","CONFIG"]}(),function(){"use strict";function a(a,b){var c=this;c.navigateState=b.getNavigateState(),a.$watch("historyCtrl.navigateState",function(a){c.navigateState=a},!0),c.showPrevious=b.showPrevious,c.showNext=b.showNext}angular.module("ghsts-history").controller("HistoryController",a),a.$inject=["$scope","HistoryService"]}(),function(){"use strict";function a(a){
////////////
function b(a){e=a}function c(){return e}function d(b){
// update Desktop-Viewer so the bookmarks can be saved on exit
if(
// remove bookmark, if it exists already
// add it, if it doesn't exist
e[b]?delete e[b]:e[b]=!0,window.parent.viewerAPI){var c=a.getViewModel("dossier");window.parent.viewerAPI.updateBookmarks(c,e)}}var e={},f={load:b,get:c,set:d};return f}angular.module("ghsts-bookmark",["ghsts-model","ghsts-state-service"]).service("BookmarkService",a),a.$inject=["GhstsModelData"]}(),function(){"use strict";function a(a,b,c){var d=this;d.state=c.getState(),d.currentDoc=d.state.Detail.currentDocument,a.$watch("bookmarkCtrl.state.Detail.currentDocument",function(){d.currentDoc=c.getState().Detail.currentDocument},!0),d.set=function(){d.currentDoc&&b.set(d.currentDoc._Id)},d.bookmarks=b.get()}angular.module("ghsts-bookmark").controller("BookmarkController",a),a.$inject=["$scope","BookmarkService","GhstsStateService"]}(),function(){"use strict";function a(a,b,c,d){var e=this;e.FilterData=b.getFilterData(),e.Filter=b.getFilter(),e.State=c,e.useAnnotations=d.USE_ANNOTATIONS,a.$watch("filterCtrl.Filter",c.deselectElementOnFilter,!0)}angular.module("ghsts-controller-filter",["ghsts-filter-service"]).controller("FilterController",a),a.$inject=["$scope","GhstsViewerFilter","GhstsStateService","CONFIG"]}(),function(){"use strict";function a(a){
////////////
function b(){var b=a.getViewModel("filter");h={RAs:b.RAs,Submissions:b.Submissions}}function c(){h||b(),j.filterOnRA="ALL",j.changedSince="all",j.searchText="",j.hideEmptyNodes=!1,j.favorites=!1}function d(){return h}function e(a,b){j[a]=b}function f(){return j}function g(){return!("ALL"===j.filterOnRA&&"all"===j.changedSince&&0===j.searchText.length&&j.hideEmptyNodes===!1&&j.favorites===!1)}
// Public Interface
var h,i={getFilterData:d,getFilter:f,setFilter:e,initFilter:c,isFilterActive:g},j={};return i}var b=angular.module("ghsts-filter-service",["ghsts-model"]);b.setConfidentialFlag=function(a,b){if(b.confidential=!1,"ALL"===a){for(var c=0;c<b.confidentialForRA.length;c++)if(b.confidentialForRA.indexOf(a)){b.confidential=!0;break}}else-1!=b.confidentialForRA.indexOf(a)&&(b.confidential=!0)},b.service("GhstsViewerFilter",a),a.$inject=["GhstsModelData"]}(),function(){"use strict";function a(){return{priority:1,restrict:"A",require:"ngModel",link:function(a,b,c,d){"radio"!==c.type&&"checkbox"!==c.type&&(b.off("input keydown change"),b.on("blur",function(){a.$apply(function(){d.$setViewValue(b.val())})}),b.bind("keydown keypress",function(c){
// enter key
13===c.which&&a.$apply(function(){d.$setViewValue(b.val())})}))}}}angular.module("ghsts-controller-filter").directive("filterChangeEvents",a)}(),function(){"use strict";function a(a){var b=this;return b.Filter=a.getFilter(),function(a){var c=[];if(a)for(var d=0;d<a.length;d++){var e=a[d];"ALL"===b.Filter.filterOnRA||-1!=e.forRA.indexOf(b.Filter.filterOnRA)?e.filtered=!1:e.filtered=!0,c.push(e)}return c}}angular.module("ghsts-filter-service").filter("documentFilterOnRA",a),a.$inject=["GhstsViewerFilter"]}(),function(){"use strict";function a(a){var b=this;return b.Filter=a.getFilter(),function(a){var c=[];if(a)for(var d=0;d<a.length;d++)"ALL"!==b.Filter.filterOnRA&&-1==a[d].forRA.indexOf(b.Filter.filterOnRA)||c.push(a[d]);return c}}angular.module("ghsts-filter-service").filter("filterOnRA",a),a.$inject=["GhstsViewerFilter"]}(),function(){"use strict";function a(a,c){var d=this;return d.Filter=a.getFilter(),d.bookmarks=c.get(),function(a){function c(a){a.isVisible=!0,a.docCount=1,b.setConfidentialFlag(d.Filter.filterOnRA,a)}function e(a){if(""===d.Filter.searchText)return void c(a);
// TODO refactor with setListVisibilityFilter
// build a list of items that should be matched with the filter text
var b=[];b.push(a.currentStatus),b.push(a.parentName),a.DOCUMENT_NUMBER.forEach(function(a){b.push(a.IDENTIFIER)}),b.push(a.DOCUMENT_COMPANY_ID),b.push(a.DOCUMENT_AUTHOR),b.push(a.name),b.push(a.ISSUE_DATE.split("-")[0]),a.TEST_LABORATORY.forEach(function(a){b.push(a)}),""===a.COMPLETE_DOCUMENT_SOURCE?b.push(a.DOCUMENT_SOURCE+", Year: "+a.DOCUMENT_YEAR+", Issue: "+a.DOCUMENT_ISSUE+", Volume: "+a.DOCUMENT_VOLUME+", Pages: "+a.DOCUMENT_PAGES):b.push(a.COMPLETE_DOCUMENT_SOURCE),a.DOCUMENT_OWNER.forEach(function(a){b.push(a)});var e=!1;b.forEach(function(a){a&&-1!=a.indexOf(d.Filter.searchText)&&(e=!0)}),e&&c(a)}function f(a){if(a.docCount=0,a.children&&a.children.length>0)for(var b=0;b<a.children.length;b++)f(a.children[b]),a.docCount+=a.children[b].docCount;"NODE"===a.type&&(d.Filter.hideEmptyNodes===!0?a.isVisible=a.docCount>0:a.isVisible=!0),"DOC"===a.type&&(a.isVisible=!1,a.docCount=0,"ALL"!==d.Filter.filterOnRA&&-1==a.forRA.indexOf(d.Filter.filterOnRA)||("all"===d.Filter.changedSince||parseInt(a.lastChange.Submission)>=parseInt(d.Filter.changedSince))&&(d.Filter.favorites&&!d.bookmarks[a.id]||e(a)))}return f(a[0]),a}}var b=angular.module("ghsts-filter-service");b.filter("setTOCVisibilityFilter",a),a.$inject=["GhstsViewerFilter","BookmarkService"]}(),function(){"use strict";function a(a,c){var d=this;return d.Filter=a.getFilter(),d.bookmarks=c.get(),function(a){function c(a){a.isVisible=!0,b.setConfidentialFlag(d.Filter.filterOnRA,a),g.push(a)}
// check for attribute match if filter is set
function e(a){if(""===d.Filter.searchText)return void c(a);
// build a list of items that should be matched with the filter text
var b=[];b.push(a.currentStatus),a.toc_refs.forEach(function(a){b.push(a.name)}),a.DOCUMENT_NUMBER.forEach(function(a){b.push(a.IDENTIFIER)}),b.push(a.DOCUMENT_COMPANY_ID),b.push(a.DOCUMENT_AUTHOR),b.push(a.name),b.push(a.DOCUMENT_ISSUE_DATE.split("-")[0]),a.TEST_LABORATORY.forEach(function(a){b.push(a)}),""===a.COMPLETE_DOCUMENT_SOURCE?b.push(a.DOCUMENT_SOURCE+", Year: "+a.DOCUMENT_YEAR+", Issue: "+a.DOCUMENT_ISSUE+", Volume: "+a.DOCUMENT_VOLUME+", Pages: "+a.DOCUMENT_PAGES):b.push(a.COMPLETE_DOCUMENT_SOURCE),a.DOCUMENT_OWNER.forEach(function(a){b.push(a)});var e=!1;b.forEach(function(a){-1!=a.indexOf(d.Filter.searchText)&&(e=!0)}),e&&c(a)}function f(a){a.isVisible=!1,"ALL"!==d.Filter.filterOnRA&&-1==a.forRA.indexOf(d.Filter.filterOnRA)||("all"===d.Filter.changedSince||parseInt(a.lastChange.Submission)>=parseInt(d.Filter.changedSince))&&(d.Filter.favorites&&!d.bookmarks[a.Id]||e(a))}for(var g=[],h=0;h<a.length;h++)f(a[h]);return g}}var b=angular.module("ghsts-filter-service");b.filter("setListVisibilityFilter",a),a.$inject=["GhstsViewerFilter","BookmarkService"]}(),function(){"use strict";function a(){return function(a){return a&&a.length>0?a.slice().reverse():a}}angular.module("ghsts-filter-service").filter("reverse",a),a.$inject=[]}(),function(){"use strict";function a(a,b,c,d){
////////////
function e(a,d){console.log("tableChanged"),
// set reference back to menu, as this list is filtered and sorted on the scope
b.setViewModel("DOCLIST",g.doclist),
// trigger scroll if tablestate changed - sort may have changed
c.setTablestate(a)}
//change in the real data holder
function f(a){
// if we click the same again don't deselect the row
"undefined"!=typeof a&&a===g.lastClickedRowX?a.isSelected=!0:g.lastClickedRowX&&(g.lastClickedRowX.isSelected=!1),g.lastClickedRowX=g.currentlySelectedItem=a}var g=this;g.doclist=b.getViewModel("doclist"),g.state=c.getState(),g.tableChanged=e,g.rowSelected=f,a.$watch("docTblCtrl.state.Detail.currentDocument",function(a){g.rowSelected(a)},!0),g.bookmarks=d.get()}angular.module("ghsts-document-table",["smart-table"]).controller("smartTableCtrl",a),a.$inject=["$scope","GhstsModelData","GhstsStateService","BookmarkService"]}(),function(){"use strict";function a(){return{restrict:"E",templateUrl:"partials/structure/document-table.tpl.html",transclude:!0}}angular.module("ghsts-document-table").directive("ghstsDocTable",a)}(),function(){"use strict";/*
  * Build listener to get recognized if sorting of table changes
  */
function a(a){return{require:"stTable",scope:{stListener:"="},link:{pre:function(a,b,c,d){var e=d.pipe;d.pipe=function(){e(),a.stListener(d.tableState(),d)}}}}}angular.module("ghsts-document-table").directive("stListener",a),a.$inject=["stConfig"]}(),function(){"use strict";
// reformat date string - only return year
function a(){return function(a){return a?a.split("-")[0]:a}}angular.module("ghsts-document-table").filter("tableDateFilter",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){
////////////
function i(a,b,c){a.preventDefault();var d="document";c&&"NODE"===c?d="node":c&&"TOC"===c?d="toc":(e.setDetailDocumentById(b),e.setViewerState("TOC"))}function j(a){return"DOC"!==a.type&&"NODE"!==a.type?a:a.isVisible===!0?a:void 0}function k(a){return new Array(4-a.toString().length)}function l(a,d){var e,g;switch(a.type){case f.annotationTypes.document:e=c.getDocumentById(a.id).DOCUMENT_GENERIC.DOCUMENT_PID,g=f.annotationTypes.document,m.showDocument(a.id,a.type);break;case f.annotationTypes.node:e=a.id,g=f.annotationTypes.node,d.stopPropagation();break;case f.annotationTypes.toc:e=b.ViewModel.DOSSIER.DOSSIER_PID,g=f.annotationTypes.dossier,d.stopPropagation()}f.annotationManager.setReferencePID(e,g)}var m=this;m.treedata=b.getViewModel("tree"),m.TreeState=e.getState().Tree,m.Filter=d.getFilter(),m.treeopts={nodeChildren:"children",dirSelectable:!1,equality:function(a,b){return a&&b?a.nodeIndex===b.nodeIndex:!1}},m.bookmarks=g.get(),m.annotationsActivated=!1,h.USE_ANNOTATIONS&&(m.annotationsActivated=f.settings.isActivated(),a.$watch(function(){return f.settings.isActivated()},function(){m.annotationsActivated=f.settings.isActivated()}),m.getAvailabilityStateIcon=f.annotationAvailability.getAvailabilityStateIcon),m.showDocument=i,m.showOnlyVisible=j,m.getNodeLeadingSpaces=k,m.activateAnnotation=l}angular.module("ghsts-controller-toc",["ghsts-model","treeControl"]).controller("TocController",a),a.$inject=["$scope","GhstsModelData","GhstsModelNavigation","GhstsViewerFilter","GhstsStateService","AnnotationService","BookmarkService","CONFIG"]}(),function(){"use strict";function a(){return{restrict:"E",templateUrl:"partials/structure/toc.tpl.html",replace:!0}}angular.module("ghsts-controller-toc").directive("ghstsToc",a)}(),function(){"use strict";function a(){return function(a,b,c){
// toc is loaded and rendered at this point
a.mainCtrl.tocLoaded=!0}}angular.module("ghsts-controller-toc").directive("tocLoaded",a)}(),function(){"use strict";function a(a,b,c){
////////////
function d(a,c){b.setTreeSelected(c,a.index),b.setDetailDocumentById(c),"TOC"!==j.State.Viewer.StructureView&&b.setViewerState("TOC")}function e(a){b.setTreeSelected(a),b.setDetailDocumentById(a),"TABLE"===j.State.Viewer.StructureView&&"DOCUMENT"===j.State.Viewer.DetailView||b.setViewerState("TABLE")}function f(a){return a.retired?"doc-retired":a.confidential?"doc-confidential":"doc-normal"}function g(a){return"DOC"!==a.type?"doc-folder":j.getDocClass(a)}function h(a,b){return"undefined"==typeof b&&(b=25),10>b&&(b=10),a.length>b-5?a.substr(0,b-5)+"(...)":a}function i(a,b){for(var c="",d=0;d<a.length;d++){var e=a[d];"undefined"!=typeof b&&(e=j.shortenString(a[d],b)),c+=e+"<br/>"}return c}var j=this;j.State=b.getState(),j.doclist=a.getViewModel("doclist"),j.showDocumentInToc=d,j.showDocumentInTable=e,j.getTocDocClass=g,j.getDocClass=f,j.shortenString=h,j.concatString=i,j.concatFullString=function(a){return i(a)}}angular.module("ghsts-controller-structure",["ghsts-model","ghsts-state-service","ghsts-filter-service"]).controller("StructureController",a),a.$inject=["GhstsModelData","GhstsStateService","CONFIG"]}(),function(){var a=angular.module("ghsts-detail-controllers",["ghsts-model","ghsts-state-service","ghsts-constants","ghsts-util"]);a.controller("DetailController",["$scope","$timeout","GhstsModelData","GhstsStateService","GhstsViewerFilter","CONFIG",function(a,b,c,d,e,f){a.config=f,a.State=d.getState(),a.activeTabIndex=0,a.mainFile={active:!0},a.allDocumentsFiltered=!1,a.Filter=e.getFilter(),a.$watch("Filter",function(b){if("undefined"==typeof a.State.Detail.currentDocument){
// check if no document is available (all filtered)
var d=c.getViewModel("tree");a.allDocumentsFiltered=d&&d.tree&&d.tree[0]&&0===d.tree[0].docCount}},!0),a.$watch("State.Detail.currentDocument",function(b){
// find the last active tab
var c;
// load all available RAs in the whole submission
// and match them with the RAs available in this document
// we want to only show the detail versions of the 'available' ones
if(a.raList&&a.raList.forEach(function(a){a.active&&(c=a.id)}),c?a.mainFile.active=!1:a.mainFile.active=!0,e.getFilterData()){var d=e.getFilterData().RAs,f=[];a.State.Detail.currentDocument&&(f=a.State.Detail.currentDocument.DOCUMENT_RA),a.raList=[],d.forEach(function(b){var d=!1;f.forEach(function(c){c.RA._Id===b.Id&&(c.id=b.Id,c.available=!0,c.active=!1,a.raList.push(c),d=!0)}),d||a.raList.push({id:b.Id,RA:{SHORT_NAME:b.Name},forRA:b.Name,available:!1,active:!1}),
// check if the last added ra tab has been active
c&&b.Id===c&&(a.raList[a.raList.length-1].active=!0)})}}),a.selectMainTab=function(){a.selectTab(0)},a.selectTab=function(c){console.log("Select tab: "+c),b(function(){a.activeTabIndex=c})}}]),a.controller("DocumentController",["$scope","$timeout","$window","GhstsStateService","EmbedFileService","CONFIG",function(a,b,c,d,e,f){a.Detail=d.getState().Detail,a.State=d.getState(),
// register on ui-layout splitbar resize and hide embedded pdf file iframes
// to keep the mouse focus when dragging into the file area
a.resizing=!1,a.$on("ui.layout.resize",function(b,c,d){a.resizing=!0}),angular.element(c).on("mouseup",function(){
// wait for last ui-layout resize debounce to finish
b(function(){a.resizing&&a.$apply(function(){a.resizing=!1})},50)}),a.$watch("State.Detail.currentDocument",function(b){a.State.Detail.currentDocument&&(
// $scope.pdfSource = config.PDFJS_FILE_PATH
//     + encodeURIComponent(
//     '../' + config.SUBMISSION_ROOT + $scope.State.Detail.currentDocument.DOCUMENT_GENERIC.MAIN_FILE_PATH);
a.pdfSource=f.SUBMISSION_ROOT+a.State.Detail.currentDocument.DOCUMENT_GENERIC.MAIN_FILE_PATH)}),a.selectTreeNode=function(a,b){d.setTreeSelected(a,b),"TOC"!==d.getState().Viewer.StructureView&&d.setViewerState("TOC")},a.openFile=function(b,c,g){
// don't open the main file twice - set it only active
if(console.log("openFile: "+b),a.Detail.currentDocument.DOCUMENT_GENERIC.MAIN_FILE_PATH===g)a.$parent.selectMainTab();else{
// only open web-viewable files
var h=e.getFileExtension(g);if("pdf"===h||"html"===h||"xml"===h){
// calculate tab index for new file tab
var i=a.$parent.raList.length+1;a.State.Detail.openFiles&&(
// TODO this doesn't work, as the openFiles may contain the file we try to open
i+=a.State.Detail.openFiles.length);var j={id:b,tabIndex:i,title:c,path:g,src:f.SUBMISSION_ROOT+g};d.openFileFromDocument(j),a.$parent.selectTab(i)}else if("undefined"!=typeof parent.viewerAPI){var k=parent.viewerAPI.getSubmissionPath()+g;parent.viewerAPI.openTab("File",k)}else window.open(f.SUBMISSION_ROOT+g)}}}]),a.controller("DossierController",["$scope","GhstsModelData",function(a,b){a.vm=b.getViewModel("dossier"),a.openSubmission=function(a){if(angular.isDefined(parent.viewerAPI)){var c=b.getSubmissionPath(window.location),d=c+"../../../"+a+"/";parent.viewerAPI.openSubmission(d)}}}]),a.controller("ProductController",["$scope","GhstsModelData",function(a,b){a.vm=b.getViewModel("product")}]),a.controller("PartnersController",["$scope","GhstsModelData",function(a,b){a.PartnersViewModel=b.getViewModel("partners"),a.showPartnerDetails=function(b){for(var c=0;c<a.PartnersViewModel.length;c++){if(a.PartnersViewModel[c].REF_LE_Id==b){a.legalEntity=a.PartnersViewModel[c].LEGAL_ENTITY;break}for(var d=0;d<a.PartnersViewModel[c].SENDER.length;d++)if(a.PartnersViewModel[c].SENDER[d].REF_LE_Id==b){a.legalEntity=a.PartnersViewModel[c].SENDER[d].LEGAL_ENTITY;break}}}}]),a.controller("InfoController",["$scope","GhstsModelData","CONFIG",function(a,b,c){a.config=c,a.model=b.getViewModel("info"),a.openPathFolder=function(){},a.shortenPath=function(a,b){return"undefined"==typeof b&&(b=50),10>b&&(b=10),a.length>b-5?"(...)"+a.substr(a.length-(b-5),a.length):a}}]),a.directive("mimeIcon",function(){return{restrict:"E",template:'<i title="Filetype: {{mimeType}}" alt="{{mimeType}}" class="fa fa-fw" ng-class="fileIcon"></i>',replace:!0,scope:{mimeType:"@"},controller:["$scope",function(a){a.$watch("mimeType",function(b){if(b)switch(b.toString().toUpperCase()){case"PDF":a.fileIcon="fa-file-pdf-o";break;case"DOC":case"DOCX":a.fileIcon="fa-file-word-o";break;case"TXT":a.fileIcon="fa-file-text-o";break;case"JPG":case"JPEG":case"PNG":case"GIF":a.fileIcon="fa-file-image-o";break;case"ZIP":case"TAR":case"GZ":a.fileIcon="fa-file-zip-o";break;default:a.fileIcon="fa-file-o"}else a.iconClass="fa-file-o"})}]}})}(),function(){"use strict";function a(a,b){
////////////
function c(a){var b=a.split(".");return b[b.length-1].toLowerCase()}function d(a,b,c,d){angular.isDefined(parent.viewerAPI)?e(a,c,d):f(a,b,c,d)}function e(a,c,d){if("function"==typeof parent.viewerAPI.doesFileExist){
// get viewer path to search for submission via desktop viewer
var e=b.getSubmissionPath(),f=parent.viewerAPI.getSubmissionPath(e),g=f+"utils/viewer/"+a;parent.viewerAPI.doesFileExist(g)?"function"==typeof c&&c():"function"==typeof d&&d()}}function f(a,b,c,d){var e=function(){"function"==typeof c&&b.$apply(function(){c(a)})},f=function(){"function"==typeof d&&b.$apply(function(){d(a)})},g=new XMLHttpRequest;g.onload=e,g.onerror=f;try{g.open("GET",a),g.responseType="arraybuffer",g.send()}catch(h){f()}}
// Public Interface
var g={getFileExtension:c,loadFile:d};return g}angular.module("ghsts-detail-controllers").service("EmbedFileService",a),a.$inject=["CONFIG","UtilService"]}(),function(){"use strict";function a(){function a(a,b,c){a.$watch(function(){return c.fileSrc},function(){""!==c.fileSrc&&a.vm.loadFile(c.fileSrc)})}var c={restrict:"E",templateUrl:"partials/detail-panel/embed-file.html",link:a,controller:b,controllerAs:"vm",bindToController:!0};return c}function b(a,b,c,d,e){function f(a,b){if(i.fileSource=a,
// build full path to file
i.fullFileSource="",angular.isDefined(parent.viewerAPI)&&"function"==typeof parent.viewerAPI.getSubmissionPath){var f=a;0===a.indexOf(d.SUBMISSION_ROOT)&&(f=a.substring(d.SUBMISSION_ROOT.length));
// get viewer path to search for submission via desktop viewer
var g=e.getSubmissionPath();i.fullFileSource=parent.viewerAPI.getSubmissionPath(g)+f}"pdf"===c.getFileExtension(a)?i.fileViewerSource=d.PDFJS_FILE_PATH+encodeURIComponent("../"+a):i.fileViewerSource=a,i.fileLoaded=b,
// convert to forward slashes
i.fileViewerSource=i.fileViewerSource.replace(/\\/g,"/"),i.fullFileSource=i.fullFileSource.replace(/\\/g,"/")}function g(a){console.debug("file not loaded: "+a),f(a,!1)}function h(b){
// check file before loading pdf.js
var d=function(){console.debug("fileLoaded: "+b),f(b,!0)},e=function(){g(b)};c.loadFile(b,a,d,e)}var i=this;i.fileSource="",i.fullFileSource="",i.fileLoaded=!1,i.loadFile=h,
// this reference will be set, when the iframe with the pdf viewer loads
i.embedFileDocument=void 0}angular.module("ghsts-detail-controllers").directive("embedFile",a),b.$inject=["$scope","GhstsStateService","EmbedFileService","CONFIG","UtilService"]}(),function(){"use strict";
// new attribute to enforce the refreshing of the PDF file displayed
function a(){function a(a,b,c){var d=b;a.$watch(function(){return c.embedFileSrc},function(){if(""!==c.embedFileSrc){var a=b.clone().attr("src",c.embedFileSrc);d.replaceWith(a),d=a}})}var b={restrict:"A",link:a};return b}angular.module("ghsts-detail-controllers").directive("embedFileSrc",a)}(),function(){"use strict";var a=angular.module("ghsts-annotations",["ghsts-model","ghsts-state-service","ghsts-constants"]);/**
     * TODO:
     *  - no-data-handling
     *      -> no annotation data
     *      -> no user data
     *  - button to generally activate annotation module
     *      -> prepared in AnnotationService.settings.activateAnnotations(bool)
     *  - 'annotated nodes only'-filter for toc view
     *      -> maybe prepared by availability checking (AnnotationService.annotationAvailability)
     *  - improvement in management of meta data (author, organisation)
     *      -> all authors could be resolved at initial loading
     *          > this way the annotator do not have to prepare the meta
     *      -> could also include the comments
     *          > this way the meta function links in the directive wouldn't be necessary
     * */
a.service("AnnotationService",["CONFIG","GhstsModelData","GhstsModelNavigation","GhstsStateService","$rootScope","$filter",function(a,b,c,d,e,f){/** Definition of Annotation API */
function g(){angular.isDefined(parent)?angular.isUndefined(parent.annotationAPI)?(parent.annotationAPI={connect:function(){angular.isDefined(parent.annotatorAPI)?(console.info("annotation service found annotator api"),parent.annotatorAPI.connect(h.annotationLoading.getCurrentPDFAnnotations())&&h.panel.open()):console.error("ERROR: annotation service is unable to find annotator api")},announceData:function(){
// lock annotation panel until annotator connects to load data
h.panel.showLoader(!0)},activateAnnotation:h.annotationManager.activateAnnotation,returnToCurrentDocument:function(){return h.annotationManager.setReferencePID(d.getState().Detail.currentDocument.DOCUMENT_GENERIC.DOCUMENT_PID,h.annotationTypes.document)},settings:h.settings,meta:h.meta},
// Attention:
// annotationAPI.addAnnotation is added in scope registration (AnnotationService.panel.register)
console.info("annotation api loaded")):console.info("annotation api is already loaded"):console.error("I'm an orphan - annotation service could not find a parent")}if(a.USE_ANNOTATIONS){console.log("annotation service activated");var h=this,i="annotations.json";// referring to submission root
this.annotationData=null,// main object containing annotation data
this.currentAnnotations={referencePIDs:[],// array of currently shown annotation references
annotationPID:null,// PID of currently selected annotation
newReference:{pid:null,type:null}},
// types of annotation references
this.annotationTypes={pdf:"PDF",// PDF & Document Annotations
document:"DOC",// PDF & Document Annotations
node:"NODE",// TOC-Node Annotations
toc:"TOC",// Dossier Annotations
dossier:"DOS"},this.annotationTypeNames={PDF:"PDF Annotation",DOC:"Document Annotation",NODE:"Node Annotation",TOC:"Dossier Annotation",DOS:"Dossier Annotation"},this.annotationTypeIcons={PDF:"fa-file-pdf-o",DOC:"fa-file-text",NODE:"fa-sitemap",TOC:"fa-book",DOS:"fa-book"},
// predefined annotation states
this.annotationStates={"default":{icon:"fa-dot-circle-o",color:"#0021FF"},normal:{name:"Normal",icon:"fa-dot-circle-o",color:"#333"},question:{name:"Question",icon:"fa-question-circle",color:"#842184"},critical:{name:"Critical",icon:"fa-exclamation-circle",color:"red"},idea:{name:"Idea",icon:"fa-lightbulb-o",color:"#333"},solved:{name:"Solved",icon:"fa-check-circle",color:"#1A8400"}},this.annotationLoading={loadAnnotationData:function(){console.log("load annotation data..."),$.getJSON(a.SUBMISSION_ROOT+i,function(a,c){return"success"==c&&a.dossierPID?void(b.ViewModel.DOSSIER.DOSSIER_PID==a.dossierPID?(console.info("annotations file accepted"),h.annotationData=a,h.meta.resolveAuthorList(),console.log("annotation data loaded")):(console.error("annotations file rejected"),alert("Annotation file rejected! - Dossier reference do not match!"))):(console.warn("no annotation file found"),void(h.annotationData={dossierPID:b.ViewModel.DOSSIER.DOSSIER_PID,authors:null,annotations:null}))})},getCurrentPDFAnnotations:function(){var a={data:null,error:"unexpected error while loading pdf annotations"};try{var b=h.annotationLoading.getCurrentFileObj(d.getState().Viewer.DetailView);-1!=b&&(-2==b?a.error="current documents main file not found":h.annotationData.annotations&&(h.annotationData.annotations.hasOwnProperty(b.FILE_GENERIC.FILE_PID)?(console.warn(h.annotationData.annotations[b.FILE_GENERIC.FILE_PID]),a.data=h.annotationData.annotations[b.FILE_GENERIC.FILE_PID]):a.data={},a.error=null),h.annotationManager.setReferencePID(b.FILE_GENERIC.FILE_PID,h.annotationTypes.pdf))}catch(c){console.error("Exception caught")}return a},getMainFileOfDocument:function(a){var b=$.grep(a.DOCUMENT_GENERIC.REFERENCED_TO_FILE,function(a){return"Main"==a.FILE.FILE_GENERIC.FILE_TYPE});return b.length>0?b[0].FILE:!1},getCurrentFileObj:function(a){
// to differ TOC-/List-View and File-View
switch(a){case"DOCUMENT":var b=h.annotationLoading.getMainFileOfDocument(d.getState().Detail.currentDocument);return b===!1?-2:b;case"FILE":return d.getState().Detail.currentFile;default:return-1}},saveAnnotationData:function(){return angular.isDefined(parent.viewerAPI)?parent.viewerAPI.annotationBackend.saveAnnotations(h.annotationData,parent.viewerAPI.getSubmissionPath()+i):!1}},this.annotationManager={setReferencePID:function(a,b){if(!h.annotationData)return!1;var c=!1;if(angular.isDefined(b)&&(h.currentAnnotations.newReference.type=b,h.currentAnnotations.newReference.pid=a),$.inArray(a,h.currentAnnotations.referencePIDs)>-1)return!0;var f=[a];if(angular.isDefined(b)||h.annotationData.annotations.hasOwnProperty(a))switch(c=!0,angular.isUndefined(b)&&(b=h.annotationData.annotations[a][h.annotationData.annotations[a].lastId].type),b){case h.annotationTypes.pdf:f.push(d.getState().Detail.currentDocument.DOCUMENT_GENERIC.DOCUMENT_PID),h.currentAnnotations.newReference.pid=d.getState().Detail.currentDocument.DOCUMENT_GENERIC.DOCUMENT_PID,h.currentAnnotations.newReference.type=h.annotationTypes.document;break;case h.annotationTypes.document:var g=h.annotationLoading.getMainFileOfDocument(d.getState().Detail.currentDocument);g!==!1&&f.push(g.FILE_GENERIC.FILE_PID),h.currentAnnotations.newReference.pid=a,h.currentAnnotations.newReference.type=h.annotationTypes.document;break;case h.annotationTypes.node:h.currentAnnotations.newReference.pid=a,h.currentAnnotations.newReference.type=h.annotationTypes.node;break;case h.annotationTypes.toc:case h.annotationTypes.dossier:h.currentAnnotations.newReference.pid=a,h.currentAnnotations.newReference.type=h.annotationTypes.dossier}return e.$evalAsync(function(){h.currentAnnotations.annotationPID=null,h.currentAnnotations.referencePIDs=f}),angular.isDefined(parent.annotatorAPI)&&parent.annotatorAPI.activateAnnotation(null),c},activateAnnotation:function(a,b,c){if(!h.annotationData||0==h.currentAnnotations.referencePIDs.length)return!1;b=angular.isDefined(b)?b:!0,c=angular.isDefined(c)?c:!1;var d=a.split(":"),f=d.pop(),g=d.join(":");return h.annotationManager.setReferencePID(g)&&h.annotationData.annotations[g].hasOwnProperty(f)?(e.$evalAsync(function(){h.currentAnnotations.annotationPID=a,b&&h.panel.scope&&h.panel.scope.setExpandedAnnotation(a)}),angular.isDefined(parent.annotatorAPI)&&(h.annotationData.annotations[g][f].type==h.annotationTypes.pdf?parent.annotatorAPI.activateAnnotation(f,c):parent.annotatorAPI.activateAnnotation(null)),h.panel.open(),!0):!1},annotationsAvailableForPID:function(a){return h.annotationData?h.annotationData.annotations.hasOwnProperty(a):!1},annotationsAvailableForDoc:function(a){var b=h.annotationLoading.getMainFileOfDocument(a);return h.annotationManager.annotationsAvailableForPID(a.DOCUMENT_GENERIC.DOCUMENT_PID)?!0:b!==!1?h.annotationManager.annotationsAvailableForPID(b.FILE_GENERIC.FILE_PID):!1}},this.annotationAvailability={getAvailabilityState:function(a){/* returns integer
                         * [standard indicator](-1) no annotations, (1) annotations at children only, (2) annotations at node, (3) annotations at node and children
                         * [active annotation]  (4) annotations at node, (5) annotations at node and children
                         * [selected for new]   (6) no annotations, (7) annotations at children
                         * */
var d=0,e=null;switch(a.type){case h.annotationTypes.document:var f=c.getDocumentById(a.id);return e=f.DOCUMENT_GENERIC.DOCUMENT_PID,h.annotationManager.annotationsAvailableForDoc(f)?h.currentAnnotations.referencePIDs.indexOf(e)>-1?4:2:h.currentAnnotations.referencePIDs.indexOf(e)>-1?6:-1;case h.annotationTypes.toc:case h.annotationTypes.node:e=a.type==h.annotationTypes.toc?b.ViewModel.DOSSIER.DOSSIER_PID:a.id;var g=!1;g=h.annotationManager.annotationsAvailableForPID(e);for(var i=!1,j=0;j<a.children.length&&!i;j++)i=h.annotationAvailability.getAvailabilityState(a.children[j])>0;return g?h.currentAnnotations.referencePIDs.indexOf(e)>-1?i?5:4:i?3:2:h.currentAnnotations.referencePIDs.indexOf(e)>-1?i?7:6:i?1:-1}return d},getAvailabilityStateIcon:function(a){switch(h.annotationAvailability.getAvailabilityState(a)){case 1:return h.annotationAvailability.availabilityStateIcons.annotatedInDeepOnly;case 2:return h.annotationAvailability.availabilityStateIcons.annotated;case 3:return h.annotationAvailability.availabilityStateIcons.annotatedInDeepToo;case 4:return h.annotationAvailability.availabilityStateIcons.annotated+" active";case 5:return h.annotationAvailability.availabilityStateIcons.annotatedInDeepToo+" active";case 6:return h.annotationAvailability.availabilityStateIcons.unannotated+" active";case 7:return h.annotationAvailability.availabilityStateIcons.annotatedInDeepOnly+" active"}return h.annotationAvailability.availabilityStateIcons.unannotated},availabilityStateIcons:{unannotated:"fa-comment-o",annotatedInDeepOnly:"fa-commenting-o",annotated:"fa-comment",annotatedInDeepToo:"fa-commenting"}},this.settings={isActivated:function(){return h.settings.isEditable()?parent.viewerAPI.annotationBackend.getPreferences().showAnnotations:!1},activateAnnotations:function(a,b){if(h.settings.isEditable()){if(a==h.settings.isActivated())return!0;var c=parent.viewerAPI.annotationBackend.setPreference("showAnnotations",a);return c&&angular.isUndefined(b)&&h.settings.activateAnnotationsInPDF(a),c}return!1},isActivatedInPDF:function(){return h.settings.isActivated()?parent.viewerAPI.annotationBackend.getPreferences().showPdfAnnotations:!1},activateAnnotationsInPDF:function(a,b){if(h.settings.isEditable()){if(a==h.settings.isActivatedInPDF())return!0;if(!a||a&&h.settings.isActivated()||a&&!h.settings.isActivated()&&h.settings.activateAnnotations(!0,!0))return angular.isUndefined(b)&&parent.annotatorAPI.activateAnnotatorModule(a),parent.viewerAPI.annotationBackend.setPreference("showPdfAnnotations",a)}return!1},isEditable:function(){return a.USE_ANNOTATIONS&&angular.isDefined(parent.viewerAPI)},getUser:function(){if(h.settings.isEditable()){var a=parent.viewerAPI.annotationBackend.getUserData();return{name:a.fullName,org:h.meta.resolveOrganisation(a.orgID),slug:a.orgID+"/"+a.username}}return null},getUserSlug:function(){return h.settings.isEditable()?parent.viewerAPI.annotationBackend.getUserSlug():null},getUserOrg:function(){return h.settings.isEditable()?parent.viewerAPI.annotationBackend.getUserData().orgID:null}},this.meta={prepareMeta:function(a){
// for annotator - preview in pdf-viewer
return{author:h.meta.resolveAuthor(a.author),date:h.meta.convertDate(a.date)}},resolveAuthor:function(a){return h.annotationData.authors&&h.annotationData.authors[a]?h.annotationData.authors[a]:null},resolveCommentAuthors:function(a){for(var b=0;b<a.length;b++)a[b].authorData=h.meta.resolveAuthor(a[b].author)},createAuthorData:function(a){a.hasOwnProperty("authorData")||(a.authorData=h.meta.resolveAuthor(a.author),h.meta.resolveCommentAuthors(a.comments))},resolveAuthorList:function(){for(var a in h.annotationData.authors)h.annotationData.authors.hasOwnProperty(a)&&(h.annotationData.authors[a].org=h.meta.resolveOrganisation(a.split("/")[0]))},resolveOrganisation:function(a){var c=b.resolveLegalEntity(a);return{name:c.hasOwnProperty("LEGALENTITY_NAME")?c.LEGALENTITY_NAME:null,abbr:c.hasOwnProperty("OTHER_NAME")?c.OTHER_NAME[0]:null}},convertDate:function(a){return f("date")(a,"dd.MM.yyyy")}},this.panel={scope:null,opened:null,showLoader:function(a){h.panel.scope&&h.panel.scope.$evalAsync(function(){h.panel.scope.showLoadingOverlay=a})},open:function(a){a=angular.isDefined(a)?a:!0,a=a&&h.settings.isActivated(),a?h.panel.opened||h.panel.resizePanel(40):h.panel.resizePanel(0),h.panel.opened=a,h.panel.showLoader(!a)},register:function(a){return h.panel.scope?(console.warn("annotation panel registration failed"),!1):(h.panel.scope=a,parent.annotationAPI.addAnnotation=h.panel.scope.addAnnotation,console.log("annotation panel registered"),!0)},resizePanel:function(a){if(!Number.isInteger(a))if(a.indexOf("%")>-1)a=a.substring(0,a.indexOf("%"));else{if(a.indexOf("px")>-1)return!1;if(!Number.isInteger(parseInt(a)))return!1;a=parseInt(a)}
// adjusting ui-layout's splitter
var b={};b.top=$("#left-top"),b.bottom=$("#left-bottom"),b.splitbar=b.top.next();var c=b.top.height()+b.bottom.height(),d=c*(a/100),e=c-d;parseInt(b.top.attr("min-size"))>e&&(e=parseInt(b.top.attr("min-size")),d=c-e),b.top.css("height",e),b.splitbar.css("top",e),b.bottom.css("top",e+b.splitbar.height()),b.bottom.css("height",d),0==d?(b.splitbar.addClass("hidden"),b.bottom.addClass("hidden")):(b.splitbar.removeClass("hidden"),b.bottom.removeClass("hidden"))}},/** Service Init */
h.annotationLoading.loadAnnotationData(),g(),/** Watcher Registration */
e.$watch(function(){return h.settings.isActivated()},function(){h.panel.open(h.settings.isActivated())}),e.$watch(function(){return d.getState().Viewer.DetailView},function(){h.panel.open(!1)}),e.$watch(function(){return d.getState().Detail.currentDocument},function(){h.panel.showLoader(!0)}),console.info("annotation service loaded")}}]),a.controller("AnnotationController",["AnnotationService","GhstsStateService","GhstsModelData","$scope",function(a,b,c,d){function e(){if(d.newAnnotation&&d.cancelAnnotation(),d.newComment&&d.cancelComment(),d.activeAnnotationPID=null,d.expandedAnnotationPID=null,d.annotationList=[],d.annoDisplayList=[],a.currentAnnotations.referencePIDs.length>0){for(var b=0;b<a.currentAnnotations.referencePIDs.length;b++)if(a.annotationData.annotations.hasOwnProperty(a.currentAnnotations.referencePIDs[b]))for(var c in a.annotationData.annotations[a.currentAnnotations.referencePIDs[b]])a.annotationData.annotations[a.currentAnnotations.referencePIDs[b]].hasOwnProperty(c)&&a.annotationData.annotations[a.currentAnnotations.referencePIDs[b]][c].hasOwnProperty("id")&&(a.meta.createAuthorData(a.annotationData.annotations[a.currentAnnotations.referencePIDs[b]][c]),d.annotationList.push(a.annotationData.annotations[a.currentAnnotations.referencePIDs[b]][c]));d.annoDisplayList=[].concat(d.annotationList)}d.annotationList.length>0?a.panel.open(!0):d.isEditable&&a.currentAnnotations.referencePIDs.length>0?(d.addAnnotation(),a.panel.open(!0)):a.panel.open(!1)}console.log("annotation controller activated"),/** scope variables */
d.annotationList=null,// List of files annotations
d.annoDisplayList=null,// List of files annotations for smart table
d.activeAnnotationPID=null,// Current detailed annotation
d.expandedAnnotationPID=null,// Current expanded (comment view) annotation
d.newRef=a.currentAnnotations.newReference,// Meta data for new annotation
d.newAnnotation=null,// temporary object for creation of new annotation
d.newComment=null,// temporary object for creation of new comment
d.editObject=null,// temporary object for editing of annotations or comments
d.showFilter=!1,// Indicator for expanded table head (filters)
d.showAddresseeList=!1,// Indicator for expanded organisation list (new annotation)
d.showLoadingOverlay=!0,// Indicator for loading overlay (with spinner)
/** scope variable references */
d.isEditable=a.settings.isEditable(),d.organisationList=c.ViewModel.LEGAL_ENTITIES,d.annotationTypes=a.annotationTypes,d.annotationTypeNames=a.annotationTypeNames,d.annotationTypeIcons=a.annotationTypeIcons,d.annotationStates=a.annotationStates,/** scope function references */
d.isActive=a.settings.isActivated,d.activateAnnotation=a.annotationManager.activateAnnotation,d.resolveAuthor=a.meta.resolveAuthor,d.resolveOrganisation=a.meta.resolveOrganisation,/** scope functions - general */
d.visibleForUser=function(b){return b.author==a.settings.getUserSlug()||b.addressee.indexOf(a.settings.getUserOrg())>-1},d.editableByUser=function(b){return b.author==a.settings.getUserSlug()},d.setExpandedAnnotation=function(a){d.expandedAnnotationPID=a},d.getAnnotationState=function(b,c){/* possible options: 'iconOnly', 'iconClassOnly', 'colorOnly', 'styleOnly' */
var d,e,f;if(a.annotationStates.hasOwnProperty(b)?(d=a.annotationStates[b],f="<span>"+d.name+"</span>"):(d=a.annotationStates["default"],f="<span>"+b+"</span>"),e='<i class="fa fa-fw '+d.icon+'" style="color: '+d.color+';"></i>',angular.isDefined(c))switch(c){case"iconOnly":return e;case"iconClassOnly":return d.icon;case"colorOnly":return d.color;case"styleOnly":return"color: "+d.color+";"}return e+f},d.toggleAddressee=function(a){var b=$("#annotation-addressee-container-"+a)[0],c=$("#annotation-addressee-toggle-indicator-"+a)[0];"block"!=b.style.display&&(b.style.display="block",c.classList.remove("fa-angle-down"),c.classList.add("fa-angle-up"),setTimeout(function(){window.addEventListener("click",function a(d){d.target.classList.contains("annotation-addressee-overlay")||(b.style.display="none",c.classList.remove("fa-angle-up"),c.classList.add("fa-angle-down"),window.removeEventListener("click",a))})},42))},d.selectChecklistItem=function(a,b){var c=a.currentTarget;c.checked?$.inArray(c.value,b)<0&&b.push(c.value):$.inArray(c.value,b)>-1&&b.splice(b.indexOf(c.value),1)},/** scope functions - annotation management */
d.addAnnotation=function(b){if(d.newComment&&!d.cancelComment())return!1;if(d.editObject&&!d.cancelEditing())return!1;var c=angular.isDefined(b)?d.annotationTypes.pdf:d.newRef.type;return d.newAnnotation={referencePID:d.newRef.pid,type:c,annotation:"",date:(new Date).toISOString().slice(0,10),addressee:[],state:"normal",authorData:a.settings.getUser()},angular.isDefined(b)&&(a.currentAnnotations.referencePIDs.forEach(function(a){d.newRef.pid!=a&&(d.newAnnotation.referencePID=a)}),d.$evalAsync(function(){d.newAnnotation.reference=b})),!0},d.editAnnotation=function(a){return d.newAnnotation&&!d.cancelAnnotation()?!1:d.newComment&&!d.cancelComment()?!1:(d.activateAnnotation(a.pid,!0,!1),d.editObject=angular.copy(a),d.editObject.customState=null,d.annotationStates.hasOwnProperty(d.editObject.state)||(d.editObject.customState=d.editObject.state,d.editObject.state="custom"),!0)},d.saveAnnotation=function(){if(!d.newAnnotation||0==d.newAnnotation.annotation.trim().length)return!1;var b=d.newAnnotation.referencePID,c=null,e=!1;return a.annotationData.annotations.hasOwnProperty(b)?(c=++a.annotationData.annotations[b].lastId,d.newAnnotation.id=c,d.newAnnotation.pid=b+":"+c,e=!a.annotationData.annotations[b].hasOwnProperty(c)):(c=1,a.annotationData.annotations[b]={type:d.newAnnotation.type,lastId:c},d.newAnnotation.id=c,d.newAnnotation.pid=b+":"+c,e=!0),e&&(d.newAnnotation.author=d.newAnnotation.authorData.slug,d.newAnnotation.comments=[],delete d.newAnnotation.referencePID,"custom"==d.newAnnotation.state&&(d.newAnnotation.state=$("#new-custom-state").val()),a.annotationData.authors.hasOwnProperty(d.newAnnotation.author)||(delete d.newAnnotation.authorData.slug,a.annotationData.authors[d.newAnnotation.author]=d.newAnnotation.authorData),a.annotationData.annotations[b][c]=d.newAnnotation,d.annotationList.push(a.annotationData.annotations[b][c]),d.annoDisplayList.push(a.annotationData.annotations[b][c]),a.annotationData.annotations[b].type==a.annotationTypes.pdf&&parent.annotatorAPI.updateData(a.annotationData.annotations[b][c]),$(".new-addressee-checkbox").attr("checked",!1),d.newAnnotation=null,e=a.annotationLoading.saveAnnotationData()),e},d.cancelAnnotation=function(){return d.newAnnotation.hasOwnProperty("reference")&&(d.newAnnotation.id="canceled",parent.annotatorAPI.updateData(d.newAnnotation)),$(".new-addressee-checkbox").attr("checked",!1),d.newAnnotation=null,!0},d.addComment=function(b){return d.newAnnotation&&!d.cancelAnnotation()?!1:d.editObject&&!d.cancelEditing()?!1:(d.activateAnnotation(b,!0,!1),d.newComment={annotationPID:b,comment:null,date:(new Date).toISOString().slice(0,10),authorData:a.settings.getUser()},!0)},d.editComment=function(a,b){return d.newAnnotation&&!d.cancelAnnotation()?!1:d.newComment&&!d.cancelComment()?!1:(d.editObject=angular.copy(a.comments[b]),d.editObject.pid=a.pid,void(d.editObject.commentKey=b))},d.saveComment=function(){if(!d.newComment||0==d.newComment.comment.trim().length)return!1;var b=d.newComment.annotationPID.split(":"),c=b.pop(),e=b.join(":"),f=!1;return a.annotationData.annotations.hasOwnProperty(e)&&a.annotationData.annotations[e].hasOwnProperty(c)&&(a.annotationData.annotations[e][c].comments.push(d.newComment),f=!0),f&&(d.newComment.author=d.newComment.authorData.slug,delete d.newComment.annotationPID,a.annotationData.authors.hasOwnProperty(d.newComment.author)||(delete d.newComment.authorData.slug,a.annotationData.authors[d.newComment.author]=d.newComment.authorData),a.annotationData.annotations[e].type==a.annotationTypes.pdf&&parent.annotatorAPI.updateData(a.annotationData.annotations[e][c]),d.newComment=null,f=a.annotationLoading.saveAnnotationData()),f},d.cancelComment=function(){return d.newComment=null,!0},d.saveEditObject=function(b){if(!d.editObject||d.editObject.type&&0==d.editObject.annotation.trim().length||!d.editObject.type&&0==d.editObject.comment.trim().length)return!1;var c=!1,e=!1,f=(new Date).toISOString().slice(0,10),g=d.editObject.pid.split(":"),h=g.pop(),i=g.join(":");if(d.editObject.type)c=d.editObject.annotation!=b.annotation,c="custom"==d.editObject.state?c||d.editObject.customState!=b.state:c||d.editObject.state!=b.state,c=c||!(d.editObject.addressee.length==b.addressee.length&&b.addressee.every(function(a){return d.editObject.addressee.indexOf(a)>-1})),c&&a.annotationData.annotations.hasOwnProperty(i)&&a.annotationData.annotations[i].hasOwnProperty(h)&&(a.annotationData.annotations[i][h].annotation=d.editObject.annotation,a.annotationData.annotations[i][h].state="custom"==d.editObject.state?d.editObject.customState:d.editObject.state,a.annotationData.annotations[i][h].addressee=d.editObject.addressee,a.annotationData.annotations[i][h].updatedAt=f,e=!0);else if(c=d.editObject.comment!=b.comment,c&&a.annotationData.annotations.hasOwnProperty(i)&&a.annotationData.annotations[i].hasOwnProperty(h)&&d.editObject.commentKey<a.annotationData.annotations[i][h].comments.length){var j=d.editObject.commentKey;delete d.editObject.pid,delete d.editObject.commentKey,d.editObject.updatedAt=f,a.annotationData.annotations[i][h].comments[j]=d.editObject,e=!0}return e?(e=a.annotationLoading.saveAnnotationData(),d.editObject=null):c||e||(d.editObject=null,e=!0),e},d.cancelEditing=function(){return d.editObject=null,!0},d.deleteEditObject=function(){if(!d.editObject)return!1;if(confirm("Are you sure to delete this "+(d.editObject.type?"annotation including all their comments":"comment")+"?")){var b=!1,c=!1,f=d.editObject.pid.split(":"),g=f.pop(),h=f.join(":");if(d.editObject.type){if(b=a.annotationData.annotations.hasOwnProperty(h)&&a.annotationData.annotations[h].hasOwnProperty(g)){if(delete a.annotationData.annotations[h][g],a.annotationData.annotations[h].lastId==g){do a.annotationData.annotations[h].lastId--;while(a.annotationData.annotations[h].lastId>0&&!a.annotationData.annotations[h].hasOwnProperty(a.annotationData.annotations[h].lastId));0==a.annotationData.annotations[h].lastId&&delete a.annotationData.annotations[h]}c=!0,e()}}else(b=a.annotationData.annotations.hasOwnProperty(h)&&a.annotationData.annotations[h].hasOwnProperty(g)&&d.editObject.commentKey<a.annotationData.annotations[h][g].comments.length)&&(a.annotationData.annotations[h][g].comments.splice(d.editObject.commentKey,1),c=!0);return c?(c=a.annotationLoading.saveAnnotationData(),d.editObject=null):b||c||(d.editObject=null,c=!0),c}},/** scope watcher */
d.$watch(function(){return a.currentAnnotations.referencePIDs},e),d.$watch(function(){return a.currentAnnotations.annotationPID},function(){d.activeAnnotationPID=a.currentAnnotations.annotationPID?a.currentAnnotations.annotationPID:null}),/** Directive Init */
a.panel.register(d),a.panel.open(!1),console.info("annotation directive loaded")}]),a.filter("unique",function(){return function(a,b){var c=null;c=b.indexOf(".")>=0?function(c){for(var d=b.split("."),e=a[c][d.shift()]||void 0;e&&d[0];)e=e[d.shift()]||void 0;return e}:function(c){return a[c][b]};var d,e={},f=a.length,g=[];for(d=0;f>d;d++)e[c(d)]=a[d];for(d in e)g.push(e[d]);return g}}),a.directive("stResetSearch",function(){return{restrict:"EA",require:"^stTable",link:function(a,b,c,d){return b.bind("click",function(){return a.$apply(function(){var a;return a=d.tableState(),a.search.predicateObject={},a.pagination.start=0,d.pipe()})})}}}),a.directive("pdfAnnotation",["AnnotationService",function(a){return{restrict:"A",link:function(a,b,c){console.log("annotation directive activated")}}}])}(),function(){"use strict";function a(){return{restrict:"E",template:'<i class="fa {{iconClass}} fa-fw" style="color: {{iconColor}}" title="{{statusValue}}" alt="{{statusValue}}"></i>',replace:!0,scope:{statusValue:"@"},controller:["$scope",function(a){a.$watch("statusValue",function(b){if(b)switch(a.statusValue){case"No Change":a.iconClass="fa-bars",a.iconColor="dodgerblue";break;case"New":a.iconClass="fa-share",a.iconColor="limegreen";break;case"Modified":a.iconClass="fa-pencil",a.iconColor="darkorange";break;case"Replace":a.iconClass="fa-refresh",a.iconColor="firebrick";break;case"Retired":a.iconClass="fa-trash",a.iconColor="gray";break;default:a.iconClass="fa-question",a.iconColor="gray"}else a.iconClass="fa-question",a.iconColor="gray"})}]}}angular.module("GhstsViewer").directive("statusIcon",a)}(),function(){"use strict";function a(){return{restrict:"E",template:'<i bindonce="icon" bo-class="\'fa \' + icon.class + \' fa-fw\'" bo-style="{\'color\': icon.color}" bo-title="icon.status" bo-alt="icon.status"></i>',replace:!0,scope:{statusValue:"@"},controller:["$scope",function(a){switch(a.icon={},a.icon.status=a.statusValue,a.statusValue){case"No Change":a.icon["class"]="fa-bars",a.icon.color="dodgerblue";break;case"New":a.icon["class"]="fa-share",a.icon.color="limegreen";break;case"Modified":a.icon["class"]="fa-pencil",a.icon.color="darkorange";break;case"Replace":a.icon["class"]="fa-refresh",a.icon.color="firebrick";break;case"Retired":a.icon["class"]="fa-trash",a.icon.color="gray";break;default:a.icon["class"]="fa-question",a.icon.color="gray"}}]}}angular.module("GhstsViewer").directive("statusIconStatic",a)}(),function(){"use strict";function a(){return{restrict:"E",template:'<i class="fa fa-tag fa-fw" style="color: gray;" title="METADATA Status" alt="METADATA Status"></i>',replace:!0}}angular.module("GhstsViewer").directive("metadataIcon",a)}(),function(){"use strict";function a(){return{restrict:"E",template:'<i class="fa fa-files-o fa-fw" title="CONTENT Status" alt="CONTENT Status"></i>',replace:!0}}angular.module("GhstsViewer").directive("contentIcon",a)}(),function(){"use strict";function a(){return{restrict:"E",template:'         <div style="float: left; margin-left: 5px">         <a href="" ng-click="openPathFolder()" title="Show in filesystem" ng-if="fileExists">           <i class="fa fa-fw fa-folder-open-o"></i>         </a>         <i class="fa fa-fw fa-exclamation-triangle" style="color: red;" title="File does not exist" ng-if="!fileExists"></i>         </div>       ',replace:!0,scope:{path:"@",relative:"@"},controller:["$scope","GhstsModelData",function(a,b){
// build proper path
a.adjustedPath=a.path,a.relative&&(
// utils/viewer/viewerIndex.html is two levels deeper than the relative links
a.adjustedPath=b.getSubmissionPath(window.location.href)+"../../"+a.path),a.fileExists=!0,"undefined"!=typeof parent.viewerAPI&&(a.fileExists=parent.viewerAPI.doesFileExist(a.adjustedPath)),a.openPathFolder=function(){"undefined"!=typeof parent.viewerAPI&&a.fileExists&&parent.viewerAPI.openFolder(a.adjustedPath)}}]}}angular.module("GhstsViewer").directive("openFolderIcon",a)}(),function(){"use strict";function a(){return{restrict:"E",template:'         <div style="float: left;">         <a href="" ng-click="openFile()" title="Open file" ng-if="fileExists">           <i class="fa fa-fw fa-external-link"></i>         </a>         <i class="fa fa-fw fa-exclamation-triangle" style="color: red;" title="File does not exist" ng-if="!fileExists"></i>         </div>       ',replace:!0,scope:{path:"@",relative:"@"},controller:["$scope","GhstsModelData",function(a,b){
// build proper path
a.adjustedPath=a.path,a.relative&&(
// utils/viewer/viewerIndex.html is two levels deeper than the relative links
a.adjustedPath=b.getSubmissionPath(window.location.href)+"../../"+a.path),a.fileExists=!0,"undefined"!=typeof parent.viewerAPI&&(a.fileExists=parent.viewerAPI.doesFileExist(a.adjustedPath)),a.openFile=function(){"undefined"!=typeof parent.viewerAPI&&a.fileExists&&parent.viewerAPI.openFile(a.adjustedPath)}}]}}angular.module("GhstsViewer").directive("openFileIcon",a)}(),function(){"use strict";function a(){return{restrict:"E",template:'<i bindonce="icon" bo-class="\'fa \' + icon.class +\' fa-f\'" bo-style="{\'color\': icon.color}" bo-title="icon.bool" bo-alt="icon.bool"></i>',replace:!0,scope:{boolValue:"@"},controller:["$scope",function(a){switch(a.icon={},a.icon.bool=a.boolValue,a.boolValue.toString().toUpperCase()){case"TRUE":case"YES":a.icon["class"]="fa-check",a.icon.color="green";break;case"FALSE":case"NO":a.icon["class"]="fa-minus",a.icon.color="red";break;default:a.icon["class"]="fa-question",a.icon.color="gray"}}]}}angular.module("GhstsViewer").directive("boolIconStatic",a)}(),function(){"use strict";function a(){return{restrict:"E",template:'<i class="fa {{iconClass}} fa-fw" style="color: {{iconColor}}" title="{{boolValue}}" alt="{{boolValue}}"></i>',replace:!0,scope:{boolValue:"@"},controller:["$scope",function(a){a.$watch("boolValue",function(b){if(b)switch(b.toString().toUpperCase()){case"TRUE":case"YES":a.iconClass="fa-check",a.iconColor="green";break;case"FALSE":case"NO":a.iconClass="fa-minus",a.iconColor="red";break;default:a.iconClass="fa-question",a.iconColor="gray"}else a.iconClass="fa-question",a.iconColor="gray"})}]}}angular.module("GhstsViewer").directive("boolIcon",a)}();